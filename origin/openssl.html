<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>note openssl | openssl笔记</title><meta name="description" content="openssl命令行学习笔记c">
    <link rel="preload" href="/note-openssl/assets/js/runtime~app.cf3cc7e9.js" as="script"><link rel="preload" href="/note-openssl/assets/css/styles.7eb859eb.css" as="style"><link rel="preload" href="/note-openssl/assets/js/812.64b59b29.js" as="script"><link rel="preload" href="/note-openssl/assets/js/app.0686d1e8.js" as="script">
    <link rel="stylesheet" href="/note-openssl/assets/css/styles.7eb859eb.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/note-openssl/" class=""><!----><span class="site-name">openssl笔记</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="基础"><span class="title">基础</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="基础"><span class="title">基础</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note-openssl/basic/01-about.html" class="nav-link" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="示例"><span class="title">示例</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="示例"><span class="title">示例</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note-openssl/demo/" class="nav-link" aria-label="Readme"><!--[--><!--]--> Readme <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="示例解释"><span class="title">示例解释</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="示例解释"><span class="title">示例解释</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note-openssl/topic/" class="nav-link" aria-label="Readme"><!--[--><!--]--> Readme <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="初始笔记"><span class="title">初始笔记</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="初始笔记"><span class="title">初始笔记</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/note-openssl/origin/openssl.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="note openssl"><!--[--><!--]--> note openssl <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note-openssl/origin/openssl3.html" class="nav-link" aria-label="openssl 3.0"><!--[--><!--]--> openssl 3.0 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/xizhan1995/note-openssl" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="基础"><span class="title">基础</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="基础"><span class="title">基础</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note-openssl/basic/01-about.html" class="nav-link" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="示例"><span class="title">示例</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="示例"><span class="title">示例</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note-openssl/demo/" class="nav-link" aria-label="Readme"><!--[--><!--]--> Readme <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="示例解释"><span class="title">示例解释</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="示例解释"><span class="title">示例解释</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note-openssl/topic/" class="nav-link" aria-label="Readme"><!--[--><!--]--> Readme <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="初始笔记"><span class="title">初始笔记</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="初始笔记"><span class="title">初始笔记</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/note-openssl/origin/openssl.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="note openssl"><!--[--><!--]--> note openssl <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note-openssl/origin/openssl3.html" class="nav-link" aria-label="openssl 3.0"><!--[--><!--]--> openssl 3.0 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/xizhan1995/note-openssl" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">note openssl</p><ul class=""><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#名字" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="名字"><!--[--><!--]--> 名字 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#语法" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="语法"><!--[--><!--]--> 语法 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#描述-description" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="描述（Description）"><!--[--><!--]--> 描述（Description） <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#命令总览" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="命令总览"><!--[--><!--]--> 命令总览 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#配置和选项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="配置和选项"><!--[--><!--]--> 配置和选项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#配置文件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="配置文件"><!--[--><!--]--> 配置文件 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#说明" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="说明"><!--[--><!--]--> 说明 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#openssl-库的配置文件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="openssl 库的配置文件"><!--[--><!--]--> openssl 库的配置文件 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#注" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="注"><!--[--><!--]--> 注 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#还有一些-不能理解-略" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="还有一些，不能理解，略"><!--[--><!--]--> 还有一些，不能理解，略 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#include-指令" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label=".include 指令"><!--[--><!--]--> .include 指令 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-对称加密" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo: 对称加密"><!--[--><!--]--> demo: 对称加密 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#aes-256-cbc-对称加密" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="AES-256-CBC 对称加密"><!--[--><!--]--> AES-256-CBC 对称加密 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#警告-deprecated-key-derivation-used" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="警告：deprecated key derivation used"><!--[--><!--]--> 警告：deprecated key derivation used <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#pbkdf2、iv-和-salt" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="pbkdf2、IV 和 salt"><!--[--><!--]--> pbkdf2、IV 和 salt <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#q-aes-加密的时候会加入随机的盐-那解密的时候如何得知盐值" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Q. aes 加密的时候会加入随机的盐，那解密的时候如何得知盐值？"><!--[--><!--]--> Q. aes 加密的时候会加入随机的盐，那解密的时候如何得知盐值？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#q-pkbdf2-迭代多少次好呢" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Q. pkbdf2 迭代多少次好呢？"><!--[--><!--]--> Q. pkbdf2 迭代多少次好呢？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#q-pbkdf2-的默认迭代次数是多少-10000-次" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Q. pbkdf2 的默认迭代次数是多少？ 10000 次"><!--[--><!--]--> Q. pbkdf2 的默认迭代次数是多少？ 10000 次 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#实战-openssl-解密java的aes-ecb-pkcs-5padding加密结果" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实战：openssl 解密java的AES/ECB/PKCS#5Padding加密结果"><!--[--><!--]--> 实战：openssl 解密java的AES/ECB/PKCS#5Padding加密结果 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#附-要解密的数据" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="附：要解密的数据"><!--[--><!--]--> 附：要解密的数据 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#附-java-的加密、解密相关代码段" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="附：Java 的加密、解密相关代码段"><!--[--><!--]--> 附：Java 的加密、解密相关代码段 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-生成和查看rsa密钥" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo: 生成和查看rsa密钥"><!--[--><!--]--> demo: 生成和查看rsa密钥 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-生成-ecc-密钥" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo: 生成 ecc 密钥"><!--[--><!--]--> demo: 生成 ecc 密钥 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#genrsa" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="genrsa"><!--[--><!--]--> genrsa <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#rsautl" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="rsautl"><!--[--><!--]--> rsautl <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-访问远程-https-服务器并返回结果" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo：访问远程 HTTPS 服务器并返回结果"><!--[--><!--]--> demo：访问远程 HTTPS 服务器并返回结果 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#附-不要加协议前缀-识别不了" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="附：不要加协议前缀，识别不了"><!--[--><!--]--> 附：不要加协议前缀，识别不了 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#附-访问远程-http-不会有结果" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="附：访问远程 HTTP 不会有结果"><!--[--><!--]--> 附：访问远程 HTTP 不会有结果 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-提取服务端-ssl-tls-证书" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo: 提取服务端 SSL/TLS 证书"><!--[--><!--]--> demo: 提取服务端 SSL/TLS 证书 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#实例-brief-和-quiet" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实例：-brief 和 -quiet"><!--[--><!--]--> 实例：-brief 和 -quiet <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-s-server-和-s-client-发送消息" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo: s_server 和 s_client 发送消息"><!--[--><!--]--> demo: s_server 和 s_client 发送消息 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-s-server-做简单的http服务器" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo: s_server 做简单的HTTP服务器"><!--[--><!--]--> demo: s_server 做简单的HTTP服务器 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#附-openssl-s-server-总是需要tls证书-待续" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="附：openssl s_server 总是需要tls证书 待续"><!--[--><!--]--> 附：openssl s_server 总是需要tls证书 待续 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#选项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="选项"><!--[--><!--]--> 选项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#配置" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="配置"><!--[--><!--]--> 配置 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#input-password-output-password" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="input_password output_password"><!--[--><!--]--> input_password output_password <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#default-bits" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="default_bits"><!--[--><!--]--> default_bits <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#default-keyfile" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="default_keyfile"><!--[--><!--]--> default_keyfile <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#oid-file-不懂" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="oid_file ？？不懂"><!--[--><!--]--> oid_file ？？不懂 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#oid-section" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="oid_section？？"><!--[--><!--]--> oid_section？？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#randfile" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="RANDFILE ？？"><!--[--><!--]--> RANDFILE ？？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#encrypt-key" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="encrypt_key"><!--[--><!--]--> encrypt_key <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#default-md" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="default_md"><!--[--><!--]--> default_md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#string-mask" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="string_mask？？"><!--[--><!--]--> string_mask？？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#req-extensions" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="req_extensions"><!--[--><!--]--> req_extensions <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#x509-extensions" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="x509_extensions"><!--[--><!--]--> x509_extensions <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#prompt" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="prompt"><!--[--><!--]--> prompt <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#utf8" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="utf8"><!--[--><!--]--> utf8 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#attributes" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="attributes？？"><!--[--><!--]--> attributes？？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#distinguished-name" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="distinguished_name"><!--[--><!--]--> distinguished_name <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#dn-信息" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="DN 信息"><!--[--><!--]--> DN 信息 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#调试" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="调试"><!--[--><!--]--> 调试 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#选项-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="选项"><!--[--><!--]--> 选项 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#输入输出和通用选项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="输入输出和通用选项"><!--[--><!--]--> 输入输出和通用选项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#查看选项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="查看选项"><!--[--><!--]--> 查看选项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#trust-settings-待续" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Trust settings    待续"><!--[--><!--]--> Trust settings    待续 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#签名选项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="签名选项"><!--[--><!--]--> 签名选项 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#说明-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="说明"><!--[--><!--]--> 说明 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#选项-2" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="选项"><!--[--><!--]--> 选项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#crl-选项-略-看不懂" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="CRL 选项 略……看不懂"><!--[--><!--]--> CRL 选项 略……看不懂 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#配置文件-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="配置文件"><!--[--><!--]--> 配置文件 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#policy-格式" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="policy 格式"><!--[--><!--]--> policy 格式 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#关于v3扩展段" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="关于v3扩展段"><!--[--><!--]--> 关于v3扩展段 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#关于database和serial选项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="关于database和serial选项"><!--[--><!--]--> 关于database和serial选项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#关于-extfile-和-extensions" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="关于 -extfile 和 -extensions"><!--[--><!--]--> 关于 -extfile 和 -extensions <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#已有密钥对-生成请求文件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="已有密钥对，生成请求文件"><!--[--><!--]--> 已有密钥对，生成请求文件 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#没有密钥对-直接生成密钥和请求文件" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="没有密钥对，直接生成密钥和请求文件"><!--[--><!--]--> 没有密钥对，直接生成密钥和请求文件 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#生成请求文件无需默认配置" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="生成请求文件无需默认配置"><!--[--><!--]--> 生成请求文件无需默认配置 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#没有密钥-直接生成自签名证书" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="没有密钥，直接生成自签名证书"><!--[--><!--]--> 没有密钥，直接生成自签名证书 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#已有密钥对-生成自签名证书" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="已有密钥对，生成自签名证书"><!--[--><!--]--> 已有密钥对，生成自签名证书 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#已有密钥对和请求文件-生成自签名证书" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="已有密钥对和请求文件，生成自签名证书"><!--[--><!--]--> 已有密钥对和请求文件，生成自签名证书 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#只有请求文件-没有私钥-无法生成自签名证书" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="只有请求文件，没有私钥，无法生成自签名证书"><!--[--><!--]--> 只有请求文件，没有私钥，无法生成自签名证书 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#x509-的-ca-系列选项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="x509 的 -CA 系列选项"><!--[--><!--]--> x509 的 -CA 系列选项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#ca-命令" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ca 命令"><!--[--><!--]--> ca 命令 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#demo-验证服务器证书是否与根-ca-证书匹配" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="demo：验证服务器证书是否与根 CA 证书匹配"><!--[--><!--]--> demo：验证服务器证书是否与根 CA 证书匹配 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#证书里的中文" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="证书里的中文"><!--[--><!--]--> 证书里的中文 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/note-openssl/origin/openssl.html#证书请求-不能有-authoritykeyidentifier" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="证书请求，不能有 authorityKeyIdentifier"><!--[--><!--]--> 证书请求，不能有 authorityKeyIdentifier <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="note-openssl" tabindex="-1"><a class="header-anchor" href="#note-openssl" aria-hidden="true">#</a> note openssl</h1><p>OpenSSL 是一个开源项目，其组成主要包括一下三个组件：</p><ul><li>openssl：多用途的命令行工具</li><li>libcrypto：加密算法库</li><li>libssl：加密模块应用库，实现了ssl及tls</li></ul><p>openssl可以实现：秘钥证书管理、对称加密和非对称加密。</p><p><a href="https://crackstation.net/hashing-security.htm" target="_blank" rel="noopener noreferrer">Secure Salted Password Hashing - How to do it Properly<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a><a href="https://www.openssl.org/" target="_blank" rel="noopener noreferrer">OpenSSL官网<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><p><a href="https://www.cnblogs.com/yangxiaolan/p/6256838.html" target="_blank" rel="noopener noreferrer">openssl用法详解<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><p>2020年2月16日</p><p>openssl version OpenSSL 1.1.1d 10 Sep 2019</p><h2 id="名字" tabindex="-1"><a class="header-anchor" href="#名字" aria-hidden="true">#</a> 名字</h2><p>openssl - OpenSSL 命令行工具</p><h2 id="语法" tabindex="-1"><a class="header-anchor" href="#语法" aria-hidden="true">#</a> 语法</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>openssl command [ command_opts ] [ command_args ]

openssl list [ standard-commands | digest-commands | cipher-commands |
cipher-algorithms | digest-algorithms | public-key-algorithms]

openssl no-XXX [ arbitrary options ]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>根据 openssl help 的输出，可看到命令分为三组：标准命令、摘要命令、密码命令。 同时，摘要命令可由标准命令中的 dgst 统领，密码命令可以由标准命令中的 enc 统领。</p><h2 id="描述-description" tabindex="-1"><a class="header-anchor" href="#描述-description" aria-hidden="true">#</a> 描述（Description）</h2><p>OpenSSL是一个密码工具箱，它实现了 SSL（v2/v3）、TSL（v1）以及它们要用到的加密标准。</p><p>openssl 程序是 OpenSSL 提供的命令行接口。它可用于：</p><ul><li>公钥、私钥的创建和管理</li><li>公钥加密操作</li><li>X.509 证书、CSR、CRL 的创建</li><li>计算消息摘要</li><li>用口令加解密数据、文件</li><li>SSL/TLS 客户端与服务的测试</li><li>处理 SMTP/MIME 签名或加密过的邮件</li><li>时间戳查询、创建和验证</li></ul><h2 id="命令总览" tabindex="-1"><a class="header-anchor" href="#命令总览" aria-hidden="true">#</a> 命令总览</h2><p>openssl程序提供了丰富的命令，每个命令有很多选项和参数。大部分命令都有详细的文档和 使用示例。</p><p>许多命令支持从配置文件读取部分或全部的参数，用 -config 选项指定配置文件，或者 用环境变量 OPENSSL_CONF。如果既没有指定 -config 也没有设置 OPENSSL_CONFIG 变量， 则使用默认路径下的 openssl.conf 文件作为配置文件，默认路径在编译时指定， 使用 <code>openssl version -d</code> 确认默认配置路径。</p><p>list 命令用于列出当前可用的标准命令、实现的算法。</p><p>no-XXX 命令测试给定的命令 XXX 是否可用，如果没有，则退出码为0，否则退出值为1，并 输出XXX。这两种情况下，都把内容输出到标准输出，并保证不向stderr输出任何内容。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl no-md5
md5
$ openssl no-md6
no-md6
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>找默认配置文件</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 用包管理工具，把软件包的所有文件名都过滤一遍</span>
$ dpkg -L openssl <span class="token operator">|</span> <span class="token function">grep</span> .cnf
/etc/ssl/openssl.cnf
/usr/lib/ssl/openssl.cnf
$ ll /usr/lib/ssl/openssl.cnf
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">20</span> Jan <span class="token number">30</span>  <span class="token number">2021</span> /usr/lib/ssl/openssl.cnf -<span class="token operator">&gt;</span> /etc/ssl/openssl.cnf
<span class="token comment"># 使用 openssl 的命令行接口，更靠谱</span>
$ openssl version -d
OPENSSLDIR: <span class="token string">&quot;/usr/lib/ssl&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="配置和选项" tabindex="-1"><a class="header-anchor" href="#配置和选项" aria-hidden="true">#</a> 配置和选项</h2><p>对于命令行接口：</p><ol><li>所有的配置文件选项都可以通过命令行提供吗？不是的。至少，req 的 distinguished_name 就没有对应的命令行选项。</li></ol><p>配置文件语法规则</p><ul><li>man openssl config 配置文件的可用选项</li><li>man openssl ca</li><li>man openssl req</li><li>man openssl x509</li></ul><h2 id="配置文件" tabindex="-1"><a class="header-anchor" href="#配置文件" aria-hidden="true">#</a> 配置文件</h2><h3 id="说明" tabindex="-1"><a class="header-anchor" href="#说明" aria-hidden="true">#</a> 说明</h3><p>主配置文件 openssl.cfg。</p><p>Openssl 提供了 CONF 库读取配置文件。</p><p>文件分节，每节的开头为 <code>[ section_name ]</code></p><blockquote><p>A configuration file is divided into a number of sections. Each section starts with a line [ section_name ] and ends when a new section is started or end of file is reached. A section name can consist of alphanumeric characters and underscores.</p></blockquote><p>第一节比较特殊，它是 default，可以匿名。它的作用是托底。</p><blockquote><p>The first section of a configuration file is special and is referred to as the default section. This section is usually unnamed and spans from the start of file until the first named section. When a name is being looked up it is first looked up in a named section (if any) and then the default section.</p></blockquote><p>环境变量映射为 ENV 的节。</p><blockquote><p>The environment is mapped onto a section called ENV.</p></blockquote><p>井号开头的是注释。</p><p>.include 指令可以包含别的文件，甚至可以包含目录，但目录下的文件不可以再包含目录，只能包含文件了。相对路径是相对于程序的当前工作路径而不是相对于配置文件的路径，所以建议使用绝对路径。 可以在 .include 文件路径之间使用等号，为了照顾旧版的 openssl，它们不支持 .include 指令， 使用 = 之后，旧版 openssl 就可以直接忽略这个不认识的选项，但如果没有等号，会报错。</p><blockquote><p>Other files can be included using the .include directive followed by a path. If the path points to a directory all files with names ending with .cnf or .conf are included from the directory. Recursive inclusion of directories from files in such directory is not supported. That means the files in the included directory can also contain .include directives but only inclusion of regular files is supported there. The inclusion of directories is not supported on systems without POSIX IO support. It is strongly recommended to use absolute paths with the .include directive. Relative paths are evaluated based on the application current working directory so unless the configuration file containing the .include directive is application specific the inclusion will not work as expected. There can be optional = character and whitespace characters between .include directive and the path which can be useful in cases the configuration file needs to be loaded by old OpenSSL versions which do not support the .include syntax. They would bail out with error if the = character is not present but with it they just ignore the include.</p></blockquote><p>每个小节由若干 name=value 的键值对组成。</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token header"><span class="token punctuation">[</span> <span class="token section-name selector">CA_default</span> <span class="token punctuation">]</span></span>

<span class="token key attr-name">dir</span>             <span class="token punctuation">=</span> <span class="token value attr-value">./demoCA              # Where everything is kept</span>
<span class="token key attr-name">certs</span>           <span class="token punctuation">=</span> <span class="token value attr-value">$dir/certs            # Where the issued certs are kept</span>
<span class="token key attr-name">crl_dir</span>         <span class="token punctuation">=</span> <span class="token value attr-value">$dir/crl              # Where the issued crl are kept</span>
<span class="token key attr-name">database</span>        <span class="token punctuation">=</span> <span class="token value attr-value">$dir/index.txt        # database index file.</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>键值对中的name，允许 <code>[0-9a-zA-Z.,;-]</code>，而 value 可以包含任意字符。 name 和 value 的首尾空格会被忽略。 value 部分还允许变量替换，形式为 $var 或 ${var}，这种可以替换当前小节的变量。 要替换其它节的变量，要使用 $section::var 或者 ${section::var} 的语法。 比如，$ENV::name 可用于引用环境变量。 CONF 要求 value 部分扩展之后的长度不超过 64K，否则报错。</p><p>value 中可以用 \ 对特殊字符转义（比如$），行末使用 \ 可以续行，此外还识别 \b \t \n \r 这些转义字符。</p><p>所有上述 value 的变量扩展和转义规则都可以在 .include 指令的文件路径中使用。</p><blockquote><p>Each section in a configuration file consists of a number of name and value pairs of the form name=value</p></blockquote><blockquote><p>The name string can contain any alphanumeric characters as well as a few punctuation symbols such as . , ; and _.</p></blockquote><blockquote><p>The value string consists of the string following the = character until end of line with any leading and trailing white space removed.</p></blockquote><blockquote><p>The value string undergoes variable expansion. This can be done by including the form $var or ${var}: this will substitute the value of the named variable in the current section. It is also possible to substitute a value from another section using the syntax $section::name or ${section::name}. By using the form $ENV::name environment variables can be substituted. It is also possible to assign values to environment variables by using the name ENV::name, this will work if the program looks up environment variables using the CONF library instead of calling getenv() directly. The value string must not exceed 64k in length after variable expansion. Otherwise an error will occur. It is possible to escape certain characters by using any kind of quote or the \ character. By making the last character of a line a \ a value string can be spread across multiple lines. In addition the sequences \n, \r, \b and \t are recognized.</p></blockquote><blockquote><p>All expansion and escape rules as described above that apply to value also apply to the path of the .include directive.</p></blockquote><h3 id="openssl-库的配置文件" tabindex="-1"><a class="header-anchor" href="#openssl-库的配置文件" aria-hidden="true">#</a> openssl 库的配置文件</h3><p>基于 OpenSSL 开发的程序可以使用 OpenSSL 主配置文件或自定义配置文件自动配置 OpenSSL 的某些方面。openssl 命令行工具就是这么做的，所有 openssl 子命令默认使用 OpenSSL 主配置文件的配置，同时也可以指定别的配置文件。</p><blockquote><p>Applications can automatically configure certain aspects of OpenSSL using the master OpenSSL configuration file, or optionally an alternative configuration file. The openssl utility includes this functionality: any sub command uses the master OpenSSL configuration file unless an option is used in the sub command to use an alternative configuration file.</p></blockquote><p>要启用库配置，必须在配置文件中的默认节中配置一行，指向主配置。 比如 openssl 命令行工具就使用 openssl_conf = xxx 指定自己的主配置节，openssl_conf 也是默认的名称，自行开发的程序可以使用自定义名称，比如 my_application_conf。</p><p>Q. enable library configuration 是什么意思?</p><blockquote><p>To enable library configuration the default section needs to contain an appropriate line which points to the main configuration section. The default name is openssl_conf which is used by the openssl utility. Other applications may use an alternative name such as myapplication_conf. All library configuration lines appear in the default section at the start of the configuration file.</p></blockquote><p>配置节，由一系列 name=value 对组成，name 对应要配置的模块，而 value 的含义则取决于 模块，value 可以是另一个节的名字，其中包含模块的具体配置。</p><blockquote><p>The configuration section should consist of a set of name value pairs which contain specific module configuration information. The name represents the name of the configuration module. The meaning of the value is module specific: it may, for example, represent a further configuration section containing configuration module specific information. E.g.:</p></blockquote><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token comment"># This must be in the default section</span>
<span class="token key attr-name">openssl_conf</span> <span class="token punctuation">=</span> <span class="token value attr-value">openssl_init</span>

<span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">openssl_init</span><span class="token punctuation">]</span></span>

<span class="token key attr-name">oid_section</span> <span class="token punctuation">=</span> <span class="token value attr-value">new_oids</span>
<span class="token key attr-name">engines</span> <span class="token punctuation">=</span> <span class="token value attr-value">engine_section</span>

<span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">new_oids</span><span class="token punctuation">]</span></span>

... new oids here ...

<span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">engine_section</span><span class="token punctuation">]</span></span>

... engine stuff here ...
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p>The features of each configuration module are described below.</p></blockquote><h3 id="注" tabindex="-1"><a class="header-anchor" href="#注" aria-hidden="true">#</a> 注</h3><p>变量展开，如果变量不存在，就会报错。比如，如果引用的环境变量不存在会导致错误。 解决方案是在默认节中提供默认值，此时如果变量未定义，就会采用默认节中的定义，当然， 这要求默认节中的定义在扩展之前出现，否则不生效。<br> 例如：</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token key attr-name">HOME</span><span class="token punctuation">=</span><span class="token value attr-value">/temp</span>
<span class="token key attr-name">RANDFILE</span><span class="token punctuation">=</span> <span class="token value attr-value">${ENV::HOME}/.rnd</span>
<span class="token key attr-name">configdir</span><span class="token punctuation">=</span><span class="token value attr-value">$ENV::HOME/config</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同一个节内多次定义同一个变量，只有最后一个生效，但有些情况（比如DNS）确实需要指定多个 值，方法是忽略name中第一个句点之前的字符。 PS：好比yaml中的数组啊。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>1.OU=&quot;My first OU&quot;
2.OU=&quot;My Second OU&quot;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="还有一些-不能理解-略" tabindex="-1"><a class="header-anchor" href="#还有一些-不能理解-略" aria-hidden="true">#</a> 还有一些，不能理解，略</h3><h2 id="include-指令" tabindex="-1"><a class="header-anchor" href="#include-指令" aria-hidden="true">#</a> .include 指令</h2><p>.include 指令，被包含的文件有同名 section，会替换整个section，还是融合 section？ Ans：融合。</p><p>.include 可以理解为纯文本替换。 openssl 的配置文件，多个同名 section 会合并。</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token header"><span class="token punctuation">[</span> <span class="token section-name selector">dn</span> <span class="token punctuation">]</span></span>
<span class="token key attr-name">C</span><span class="token punctuation">=</span><span class="token value attr-value">CN</span>
<span class="token key attr-name">CN</span><span class="token punctuation">=</span><span class="token value attr-value">chenxizhan</span>

<span class="token header"><span class="token punctuation">[</span> <span class="token section-name selector">dn</span> <span class="token punctuation">]</span></span>
<span class="token key attr-name">ST</span><span class="token punctuation">=</span><span class="token value attr-value">Shandong</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>等价于</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token header"><span class="token punctuation">[</span> <span class="token section-name selector">dn</span> <span class="token punctuation">]</span></span>
<span class="token key attr-name">C</span><span class="token punctuation">=</span><span class="token value attr-value">CN</span>
<span class="token key attr-name">CN</span><span class="token punctuation">=</span><span class="token value attr-value">chenxizhan</span>
<span class="token key attr-name">ST</span><span class="token punctuation">=</span><span class="token value attr-value">Shandong</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h1 id="对称加密" tabindex="-1"><a class="header-anchor" href="#对称加密" aria-hidden="true">#</a> 对称加密</h1><h2 id="demo-对称加密" tabindex="-1"><a class="header-anchor" href="#demo-对称加密" aria-hidden="true">#</a> demo: 对称加密</h2><p>加解密、签名，或许用 gpg 更合适？</p><p>openssl提供了两种方式调用对称加密算法，openssl cipher 和 openssl enc -cipher。前者 为所有算法提供统一入口，但不能兼顾所有算法的所有选项；后者则可以兼顾完整选项。</p><p>PS：命令行接口很强大，但仍然只是部分接口，完整的功能还需要通过编程接口使用。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 加密</span>
<span class="token builtin class-name">echo</span>  hello <span class="token operator">|</span> openssl enc -aes-256-cbc -pbkdf2 -pass pass:123456 -out hello.aes
<span class="token comment"># 解密</span>
$ openssl enc -d -aes-256-cbc -pbkdf2 -pass pass:123456 -in hello.aes
hello
<span class="token comment"># 另外，openssl 生成的加密文件，gpg 不识别</span>
$ gpg -d hello.aes
gpg: no valid OpenPGP data found.
gpg: decrypt_message failed: Unknown system error
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="aes-256-cbc-对称加密" tabindex="-1"><a class="header-anchor" href="#aes-256-cbc-对称加密" aria-hidden="true">#</a> AES-256-CBC 对称加密</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 使用 AES 算法加密文件</span>
<span class="token comment"># 结果文件 hello.txt.enc 是一个二进制文件</span>
<span class="token builtin class-name">echo</span> hello <span class="token operator">&gt;</span> hello.txt
openssl enc -aes256 -in hello.txt -out hello.txt.enc -pass pass:123456
<span class="token comment"># 如果不在命令行指定密码，会提示用户输入密码，交互模式下更安全</span>

<span class="token comment"># 使用 AES 算法加密文件，并对加密结果进行 BASE64 编码</span>
<span class="token builtin class-name">echo</span> hello <span class="token operator">&gt;</span> hello.txt
openssl enc -aes256 -a -in hello.txt -out hello.txt.arm -pass pass:123456

<span class="token comment"># 解密</span>
openssl enc -aes256 -d -in hello.txt.enc --out hello2.txt
<span class="token comment"># -e 加密，-d 解密，不指定则为加密，所以解密时不能省略 -d</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="警告-deprecated-key-derivation-used" tabindex="-1"><a class="header-anchor" href="#警告-deprecated-key-derivation-used" aria-hidden="true">#</a> 警告：deprecated key derivation used</h3><p>上面的加密示例在 openssl 1.1 中会得到一个警告：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>*** WARNING : deprecated key derivation used.
Using -iter or -pbkdf2 would be better.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>只需要在加密的时候指定参数 -pbkdf2 就可以。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>openssl enc -aes256 -pbkdf2 -in hello.txt -out hello.txt.enc -pass pass:123456
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-iter count
    Use a given number of iterations on the password in deriving the encryption key.
    High values increase the time required to brute-force the resulting file.
    This option enables the use of PBKDF2 algorithm to derive the key.

-pbkdf2
    Use PBKDF2 algorithm with default iteration count unless otherwise specified.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="pbkdf2、iv-和-salt" tabindex="-1"><a class="header-anchor" href="#pbkdf2、iv-和-salt" aria-hidden="true">#</a> pbkdf2、IV 和 salt</h3><ul><li><p>pbkdf2：CBC 是一种块加密模式，块加密要求密钥有相同的长度，而密码是变长的，所以要 对密码做一些转换以便生成最终的密钥，</p><p>pbkdf2 是一种安全的密钥生成算法。</p></li><li><p>IV，Initialization Vector</p><p>CBC 模式下，每个块在加密之前要先和前一个块进行异或计算，第一个块没有前一个块， 所以提供 IV 作为初始块。</p></li><li><p>salt：为了提高安全性，相同的密码应当生成不同的密钥，这需要引入干扰项，就是盐。</p></li></ul><p>AES加密算法的CBC模式加密时实际使用密钥和IV，算法没有规定 key 和 iv 如何生成和存储。</p><p>openssl 的 AES + CBC 加密，默认通过 passwd 和 salt 生成 key 和 iv，生成过程用到 哈希算法。也可以不指定passwd，而是直接指定 key 和 iv。</p><p>openssl aes-256-cbc 加密时，要么通过 -K key 和 -iv IV 直接指定 key 和 iv。 要么通过 -pass 指定密码，然后 openssl 随机生成 salt，并使用默认哈希算法。</p><ul><li><p>用 -p 或者 -P 能查看实际使用的 key 和 iv，用于调试。</p></li><li><p>通过 -S 显式指定 salt，还可以通过 -nosalt 禁用盐。当然-S 和 -nosalt 都不够安全。</p></li><li><p>通过 -md 显式指定哈希算法。 openssl 1.0 默认使用 md5 做哈希算法，1.1 开始使用 sha256作为默认哈希， 通过 /etc/ssl/openssl.cnf 的 default_md 字段修改默认的 hash 函数。</p><p>ps：当然，解密使用的哈希算法要和加密时的哈希算法一致。</p></li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-p  Print out the key and IV used.
-P  Print out the key and IV used then immediately exit: don&#39;t do any encryption or decryption.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>AES 算法 Key 和 IV 的生成规则：将 hash 结果（第一次 hash 运算时为空）、passphrase 和 salt（nosalt 时为空）拼接后 循环做 hash 运算，再根据 AES 所需的 Key 和 IV 的 bit 数取值。</p><p>对于 AES-256-CBC 来说，MD5</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hash1_128 = MD5(Passphrase + Salt)
hash2_128 = MD5(hash1_128 + Passphrase + Salt)
hash3_128 = MD5(hash2_128 + Passphrase + Salt)
Key = hash1_128 + hash2_128
IV  = hash3_128
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>更进一步的，只要生成了足够 bit 位的值，hash 运算就停止了，这称为一个迭代，这正是 OpenSSL 为人所诟病的不足。 所以 openssl 1.1 引入了 -iter 和 -pbkdf2 参数。</p><p>AES/ECB/PKCS5Padding</p><p>块模式下，一般使用 PKCS#5 补齐。</p><blockquote><p>All the block ciphers normally use PKCS#5 padding, also known as standard block padding. This allows a rudimentary integrity or password check to be performed. However, since the chance of random data passing the test is better than 1 in 256 it isn&#39;t a very good test.</p></blockquote><ul><li><a href="https://blog.lancitou.net/how-to-generate-key-and-iv-in-openssl-aes/" target="_blank" rel="noopener noreferrer">OpenSSL AES 算法中 Key 和 IV 是如何生成的<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://security.stackexchange.com/questions/211/how-to-securely-hash-passwords/31846#31846" target="_blank" rel="noopener noreferrer">appsec - How to securely hash passwords?<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://security.stackexchange.com/questions/48000/why-would-you-need-a-salt-for-aes-cbs-when-iv-is-already-randomly-generated-and" target="_blank" rel="noopener noreferrer">encryption - Why would you need a salt for AES-CBS when IV is already randomly generated and stored with the encrypted data?<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ul><h3 id="q-aes-加密的时候会加入随机的盐-那解密的时候如何得知盐值" tabindex="-1"><a class="header-anchor" href="#q-aes-加密的时候会加入随机的盐-那解密的时候如何得知盐值" aria-hidden="true">#</a> Q. aes 加密的时候会加入随机的盐，那解密的时候如何得知盐值？</h3><p>openssl 将盐保存在加密文件的开头。验证如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 加密，使用 -p 输出盐</span>
$ openssl enc -aes-256-cbc -in hello.txt -out hello.txt.enc -pass pass:123456 -pbkdf2 -p
<span class="token assign-left variable">salt</span><span class="token operator">=</span>0AC8FA8EAFB9ECD7
<span class="token assign-left variable">key</span><span class="token operator">=</span>1BF6A315A41C0F9DA720CD4FEC7552F01C83B60C72A227D1B7D5F6EA13CE107D
iv <span class="token operator">=</span>B125FFC70231378EE7F17EEAC7AC6D08
<span class="token comment"># xxd 命令查看，能看到第10到16个字节就是盐</span>
$ xxd hello.txt.enc
00000000: <span class="token number">5361</span> 6c74 <span class="token number">6564</span> 5f5f 0ac8 fa8e afb9 ecd7  Salted__<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
00000010: <span class="token number">9864</span> 97b6 b02e ba6f ef92 e511 <span class="token number">4967</span> d3f5  .d<span class="token punctuation">..</span><span class="token punctuation">..</span>.o<span class="token punctuation">..</span><span class="token punctuation">..</span>Ig<span class="token punctuation">..</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="q-pkbdf2-迭代多少次好呢" tabindex="-1"><a class="header-anchor" href="#q-pkbdf2-迭代多少次好呢" aria-hidden="true">#</a> Q. pkbdf2 迭代多少次好呢？</h3><p><code>足够好&#39;&#39;是主观的且难以定义的，因应用程序和风险状况而异，今天的</code>足够好&#39;&#39;明天可能不会``足够好&#39;&#39;...</p><p>一些参考资料：</p><ul><li>2000年9月-建议进行1000余轮（来源：RFC 2898）</li><li>2005年2月-Kerberos 5中的AES``默认&#39;&#39;为4096轮SHA-1。 （来源：RFC 3962）</li><li>2010年9月-ElcomSoft声称iOS 3.x使用2,000次迭代，iOS 4.x使用10,000次迭代，显示BlackBerry使用1次（未声明确切的哈希算法）（来源： ElcomSoft ）</li><li>2011年5月-LastPass使用100,000次SHA-256迭代（来源： LastPass ）</li><li>2015年6月-StableBit使用了200,000次SHA-512迭代（来源： StableBit CloudDrive螺母和螺栓 ）</li><li>2015年8月-CloudBerry使用SHA-1的1,000次迭代（来源： CloudBerry实验室安全注意事项（pdf） ）</li></ul><p><a href="https://www.it-swarm.cn/zh/cryptography/%E4%BD%BF%E7%94%A8pkbdf2sha256%E6%97%B6%E5%BB%BA%E8%AE%AE%E7%9A%84%E8%BF%AD%E4%BB%A3%E6%AC%A1%E6%95%B0%EF%BC%9F/l957335351/" target="_blank" rel="noopener noreferrer">cryptography — 使用PKBDF2-SHA256时建议的迭代次数？<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><h3 id="q-pbkdf2-的默认迭代次数是多少-10000-次" tabindex="-1"><a class="header-anchor" href="#q-pbkdf2-的默认迭代次数是多少-10000-次" aria-hidden="true">#</a> Q. pbkdf2 的默认迭代次数是多少？ 10000 次</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 加密</span>
$ openssl enc -aes-256-cbc -in hello.txt -out hello.txt.enc -pass pass:123456 -pbkdf

<span class="token comment"># 解密，</span>
$ openssl enc -aes-256-cbc -d -in hello.txt.enc  -pass pass:123456 -pbkdf2
hello
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>加密解密的迭代次数必须相同。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ openssl enc -aes-256-cbc -in hello.txt -out hello.txt.enc -pass pass:123456 -iter 1000 -p

$ openssl enc -aes-256-cbc -d -in hello.txt.enc  -pass pass:123456 -iter 1001
bad decrypt
140607393125696:error:06065064:digital envelope routines:EVP_DecryptFinal_ex:bad decrypt:../crypto/evp/evp_enc.c:583:

$ openssl enc -aes-256-cbc -d -in hello.txt.enc  -pass pass:123456 -pbkdf2
bad decrypt
140513093121344:error:06065064:digital envelope routines:EVP_DecryptFinal_ex:bad decrypt:../crypto/evp/evp_enc.c:583:
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="暴力确认默认迭代次数" tabindex="-1"><a class="header-anchor" href="#暴力确认默认迭代次数" aria-hidden="true">#</a> 暴力确认默认迭代次数</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> hello <span class="token operator">&gt;</span> hello.txt
$ openssl enc -aes-256-cbc -in hello.txt -out hello.txt.enc -pass pass:123456 -pbkdf2 -p
<span class="token assign-left variable">salt</span><span class="token operator">=</span>0AC8FA8EAFB9ECD7
<span class="token assign-left variable">key</span><span class="token operator">=</span>1BF6A315A41C0F9DA720CD4FEC7552F01C83B60C72A227D1B7D5F6EA13CE107D
iv <span class="token operator">=</span>B125FFC70231378EE7F17EEAC7AC6D08
$ <span class="token function">time</span> <span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> openssl enc -aes-256-cbc -d -in hello.txt.enc  -pass pass:123456 -iter <span class="token variable">$i</span> <span class="token operator">&amp;&gt;</span>/dev/null<span class="token punctuation">;</span><span class="token keyword">then</span>
      <span class="token assign-left variable">result</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>openssl enc -aes-256-cbc -d -in hello.txt.enc  -pass pass:123456 -iter $i<span class="token variable">)</span></span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;i = <span class="token variable">$i</span>&quot;</span>, <span class="token variable">$result</span>
      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$result</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;hello&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>
    <span class="token keyword">fi</span>
    <span class="token keyword">if</span> <span class="token variable"><span class="token punctuation">((</span>i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token builtin class-name">echo</span> <span class="token variable">$i</span>
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol><li>解密失败，退出码为1；解密成功，退出码为0</li><li>根据资料，常见迭代次数 10000 以内，所以暴力尝试是可行的</li></ol><p>运行了 1.5 分钟。</p><h2 id="实战-openssl-解密java的aes-ecb-pkcs-5padding加密结果" tabindex="-1"><a class="header-anchor" href="#实战-openssl-解密java的aes-ecb-pkcs-5padding加密结果" aria-hidden="true">#</a> 实战：openssl 解密java的AES/ECB/PKCS#5Padding加密结果</h2><p>2021-11-02</p><p>项目现场开发时，对接云之家审批流，其回调数据是通过 Java 加密的。 现在用 openssl 解密数据。</p><p>要解密的数据存放在文件 demo.json.enc.base64 中。</p><p>解密命令为</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
$ <span class="token builtin class-name">echo</span> -n T22cdkEko3flglPe <span class="token operator">|</span> xxd -ps
54323263646b456b6f33666c676c5065

<span class="token comment"># 解密命令</span>
$ openssl enc -aes-128-ecb -d -K 54323263646b456b6f33666c676c5065 -a -A -in cloud-demo.json.enc.base64 -out cloud-demo.json
<span class="token comment"># 对应的加密命令</span>
$ openssl enc -aes-128-ecb -K 54323263646b456b6f33666c676c5065 -a -A -in cloud-demo.json -out cloud-demo.json.enc.base64
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>根据</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES/ECB/PKCS5Padding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;T22cdkEko3flglPe&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>得知这里使用的 AES/ECB/PKCS5Padding 加密，密钥长度 128 位，另外根据资料，使用 sha1 哈希。</p><ol><li>openssl 默认使用密码生成 key，而 Java 使用 T22cdkEko3flglPe 二进制形式直接作为 key， 所以用 xxd 取得对应的16进制形式。</li><li>密钥长度为 32 个字符，对应 128 位，所以确定为 -aes-128-ecb</li><li>openssl 默认使用 PKCS#5 方式填充，所以无需指定。另外，好像没有指定填充方式的选项？</li><li>openssl 1.1 开始，默认使用 sha1 哈希，所以无需指定，另外，通过 -md sha1 选项可以指定哈希算法</li><li>-d 表示解密</li><li>-a -base64 表示先对输入文件进行 base64 解码</li><li>-A 告诉 openssl，base64 内容没有换行。如果不指定这个，openssl 只能解密部分数据。</li><li>ecb 模式不需要初始向量（iv），所以不需要指定 -iv 选项。</li></ol><h3 id="附-要解密的数据" tabindex="-1"><a class="header-anchor" href="#附-要解密的数据" aria-hidden="true">#</a> 附：要解密的数据</h3><p>注：数据已经过脱敏处理</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>siX7DUsWDsQW702O0DAzx9h2LHIODVEbvwMdbNbUDm9sYxBNu1TMUEZitLJE0oNqsxN4pyjICLvnxgPaASaCOzCuVvpKzDpwEZX82gJX3QA1J3zxGHrA9Akrmbh1G+tJ8uQgjuULQWInxkd5L73xE8cdGbYXEgrNZK/r7z2fgJvZoo0cOnGL4KwEMQsURMBGSn2qZWo3AwHsCpzbZz6TTPYNKGJvwGP+ifp+58eDS4kvnb+zkm3uL3NWWMASkDxAJxqJkHAI7KrYp7P2ErMmNsh5cCa5niR/YRaAjvcD5go4wCbMYuEXIHbRVhwep4WLP563Z7zsmZy8P2h6hvalGEbaFD4+T3pxtvelSkmVtSptfXTm+JrGowlxKsLJ24k6xHSYqtKEi0JxAf2iW3Iijty+XvW1ab/XOtkeYf0DwzWQ3PRAykNOvHeWcrSA6LTzNbb6ds0TdRBLdxrCKyEj6Fliic7UqX6ODvPK6ivXga+qhIgLM8OO9Cx+8oKAbKY7U+hx0hT4PVDuMUYjU2Uy7bIFsGeMT5dSUhTN2LmZqOCotZ7HaWJuBxB66f7Lco7J5OXVR8ildhENnyitKkgnCgjhS0CYDPSHJyPscsijQeQdCcONxfT9lrHKImdDeQMqtsLh9w1TrWi/oxhMvFITQw82jnSa9+c0K7eErQwi1WpKuRqdN99Ui7Oz4cBJIEiUGA4R1SrPO0029BugNQZlt97UwItlAXgoX8CfnKJlbMMs+tIs0f5bMPgHgQ4+3ZVEI8hk5yq5oC/vBiILEqX1GBXH4J7bXqpjAk25Oou07s2RgbYqKFx/XAw64tc1jxIDKdiccsdblY1ZFiUJwla3VyYmS1l4UQXf1CTq6nYGqCzMDp2mzCMhEuEdaC1EWtTC5egZaFBDVaw+eqXFEAdZOCRNYrr9opCv9EalvXgaik7eZw6RlMJkmjiJROhG+WvYmeP5kHJzFIMPJZxDXRh57apdiBqoXYe0ti04SRaod3wLc3Huuu2to6KXBPu3dbmTwlpEyoRDK05c5BBuzp9/Vqo05RQGM0/W/PeLWD6rEtwReCZeJ8JLQg0CBgsvb1V4RH3Y2jR/wB1NES80qXOQQElW224OCiYe2zF8+mXVey3YcEnDi7adIVEOj89B6Q1Zz4bB0dRbvl0AOoznwz9/DZYC5S8GK9Sg0W9XzQfuneMIQ7fvEzLgLMzXV6h6CGi6Qn5328UXuWUVUEk/mI2fw1ZhwFJ5FIVjg7hI/a8PzDQC1RaFgRdvnwesxYGq3XxxF6K9qlRNsArcmoLjGqWNdUh4qnnlBcXLWpt6900DEzzIWmgAlzsPmO5S0zZXblVBx0Miy2R2+OpZkqh/Ymb0Q7m7gofC6zTOVHRvPwNT53CMwt2j1O8typ6lN4P9zcaZOd5UgsIG00wipm0upL9bPjE3tJmxT1Jkndw96/lWxFuZubU7UfDI+q5/YcoX8LM2ufH53No0JlkQxQ8mS0tc1obQPL8mNtZ8ZJFiKs+Pt6Ev8os3Lx3SPpQt/n12/AseRwgc+jrNy05Mz7Y3XlCpsFnd0kfS+ebmD4euGThk2jlpLVfVWvQ34EppRd2b54QAQPaz4M2XODiBICYynwImaw==
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="附-java-的加密、解密相关代码段" tabindex="-1"><a class="header-anchor" href="#附-java-的加密、解密相关代码段" aria-hidden="true">#</a> 附：Java 的加密、解密相关代码段</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>soflyit<span class="token punctuation">.</span>data<span class="token punctuation">.</span>governance<span class="token punctuation">.</span>web<span class="token punctuation">.</span>platform<span class="token punctuation">.</span>flow<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Cipher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">Charset</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">Key</span><span class="token punctuation">;</span>

<span class="token comment">// 128位长度的AES加密</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AESEncryptor</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Charset</span> CHARSET <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ALGORITHM <span class="token operator">=</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> aesKey<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AESEncryptor</span><span class="token punctuation">(</span><span class="token class-name">String</span> aesKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aesKey <span class="token operator">=</span> aesKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciperData <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>ciperData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecretKeySpec</span> secretKeySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>aesKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>CHARSET<span class="token punctuation">)</span><span class="token punctuation">,</span> ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES/ECB/PKCS5Padding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> secretKeySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plainData <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>plainData<span class="token punctuation">,</span> CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecretKeySpec</span> secretKeySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>aesKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>CHARSET<span class="token punctuation">)</span><span class="token punctuation">,</span> ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span> secretKeySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;NMe2JAQSnyjGMqff&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">// 解密推送数据</span>
        <span class="token comment">// 其中cipher为接收到的原始推送数据</span>
        <span class="token comment">//  很长很长，此处省略</span>
        <span class="token class-name">String</span> cipher <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">AESEncryptor</span> encryptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AESEncryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        encryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h1 id="非对称加密" tabindex="-1"><a class="header-anchor" href="#非对称加密" aria-hidden="true">#</a> 非对称加密</h1><p>rsa 和 ec 这两个。</p><p>对于 rsa，有 genrsa、rsa 和 rsautl 对于 ec，有 ecparam 和 ec 两个命令。</p><p>同时还提供了统一管理的命令，genpkey、pkey、pkparam、pkutl。</p><p>genrsa 命令生成rsa密钥，rsa 和 rsautl 不能生成。 rsa 命令管理密钥，查看、校验、格式转换。 rsautl 命令使用rsa密钥，即用密钥加密、解密、签名、校验签名。</p><p>ecparam 生成和查看 ec 密钥参数，生成 ec 密钥； ec 用于查看ec密钥。 没有 ecutl 命令。</p><p>genpkey 用于生成公钥参数（EC，DH等），用于生成公钥（RSA，DSA,EC）。 pkeyparam 用于查看公钥参数。 pkey 管理公钥。 pkutl 使用公钥。</p><h2 id="demo-生成和查看rsa密钥" tabindex="-1"><a class="header-anchor" href="#demo-生成和查看rsa密钥" aria-hidden="true">#</a> demo: 生成和查看rsa密钥</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建新密钥</span>
<span class="token comment"># 默认密钥长度为 2048 位，最后的 512 指定生成 512 位的密钥</span>
<span class="token comment"># 默认在标准输出显示密钥，-out 指定保存到文件 key.pem</span>
openssl genrsa -out key.pem <span class="token number">512</span>
openssl genrsa <span class="token number">512</span> <span class="token operator">&gt;</span> key.pem
<span class="token comment"># 或者</span>
openssl genrsa <span class="token operator">&gt;</span> key.pem

<span class="token comment"># 查看密钥信息</span>
<span class="token comment"># 默认从标准输入读取密钥，-in 指定从文件读取</span>
openssl rsa -in key.pem -noout -text
<span class="token function">cat</span> key.pem <span class="token operator">|</span> openssl rsa -noout -text

<span class="token comment"># 除了 -text 查看完整的密钥信息，也可以使用其它选项查看单独的一部分</span>
<span class="token comment"># 比如公钥</span>
openssl rsa -pubout <span class="token operator">&lt;</span> key.pem
openssl rsa -pubout <span class="token operator">&lt;</span> key.pem <span class="token operator">&gt;</span> pub.pem

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>也可以使用 genpk 命令生成 rsa 密钥</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl genpkey -algorithm rsa -out rsa.pem
openssl genpkey -algorithm rsa -pkopt rsa_keygen_bits:512 -out rsa.pem
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>具体的输出过程如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
<span class="token comment"># 创建新密钥，512位（默认2048位）</span>
$ openssl genrsa -out key.pem <span class="token number">512</span>
Generating RSA private key, <span class="token number">512</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++++++++++++++++++++++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++++++++++++++++++++++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span>

<span class="token comment"># 只有一个文件（私钥文件）</span>
$ <span class="token function">ls</span>
key.pem

<span class="token comment"># 私钥内容</span>
$ <span class="token function">cat</span> key.pem
-----BEGIN RSA PRIVATE KEY-----
MIIBOgIBAAJBAJWaPgx6yiLUE+GlDQuC6+U+gLYJtFlsfUJYz/8/AGabmF/ZDE8K
Q4oPtaJrg/5pVZMzoB7uoTfuzm/jeE3BRJUCAwEAAQJAa578SCoFRCzg6JC946wZ
W18tZMdycGo1agdOCkceWLE4wQBCoayUIK4/z8SaOXfXquQjA047mwRUDgD1ZgUE
wQIhAManFM4+ZlPHstoIiwggQQwZNgskSf7iHUUxdMuEBbrpAiEAwMo8D796WCM4
T8eufvDWBGogFZW3J/hb1LUXvq4G2M0CIEmBZYdzO3XgvONEqf1VwfvyEDdLND4l
+OKzjB4KOfyRAiAKZJyaSLtCtxtZCa25gCg5crMqFrkZ+YSR0fVmvSD3XQIhAK51
PJkOxGFOXW6OgCged7jRNAJ8gQJRS094sTKR44Om
-----END RSA PRIVATE KEY-----
<span class="token comment"># 查看密钥组件（可以看到，里面包含了公钥）</span>
$ openssl rsa -in key.pem -text
RSA Private-Key: <span class="token punctuation">(</span><span class="token number">512</span> bit, <span class="token number">2</span> primes<span class="token punctuation">)</span>
modulus:
    00:95:9a:3e:0c:7a:ca:22:d4:13:e1:a5:0d:0b:82:
    eb:e5:3e:80:b6:09:b4:59:6c:7d:42:58:cf:ff:3f:
    00:66:9b:98:5f:d9:0c:4f:0a:43:8a:0f:b5:a2:6b:
    <span class="token number">83</span>:fe:69:55:93:33:a0:1e:ee:a1:37:ee:ce:6f:e3:
    <span class="token number">78</span>:4d:c1:44:95
publicExponent: <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>
privateExponent:
    6b:9e:fc:48:2a:05:44:2c:e0:e8:90:bd:e3:ac:19:
    5b:5f:2d:64:c7:72:70:6a:35:6a:07:4e:0a:47:1e:
    <span class="token number">58</span>:b1:38:c1:00:42:a1:ac:94:20:ae:3f:cf:c4:9a:
    <span class="token number">39</span>:77:d7:aa:e4:23:03:4e:3b:9b:04:54:0e:00:f5:
    <span class="token number">66</span>:05:04:c1
prime1:
    00:c6:a7:14:ce:3e:66:53:c7:b2:da:08:8b:08:20:
    <span class="token number">41</span>:0c:19:36:0b:24:49:fe:e2:1d:45:31:74:cb:84:
    05:ba:e9
prime2:
    00:c0:ca:3c:0f:bf:7a:58:23:38:4f:c7:ae:7e:f0:
    d6:04:6a:20:15:95:b7:27:f8:5b:d4:b5:17:be:ae:
    06:d8:cd
exponent1:
    <span class="token number">49</span>:81:65:87:73:3b:75:e0:bc:e3:44:a9:fd:55:c1:
    fb:f2:10:37:4b:34:3e:25:f8:e2:b3:8c:1e:0a:39:
    fc:91
exponent2:
    0a:64:9c:9a:48:bb:42:b7:1b:59:09:ad:b9:80:28:
    <span class="token number">39</span>:72:b3:2a:16:b9:19:f9:84:91:d1:f5:66:bd:20:
    f7:5d
coefficient:
    00:ae:75:3c:99:0e:c4:61:4e:5d:6e:8e:80:28:1e:
    <span class="token number">77</span>:b8:d1:34:02:7c:81:02:51:4b:4f:78:b1:32:91:
    e3:83:a6
writing RSA key
-----BEGIN RSA PRIVATE KEY-----
MIIBOgIBAAJBAJWaPgx6yiLUE+GlDQuC6+U+gLYJtFlsfUJYz/8/AGabmF/ZDE8K
Q4oPtaJrg/5pVZMzoB7uoTfuzm/jeE3BRJUCAwEAAQJAa578SCoFRCzg6JC946wZ
W18tZMdycGo1agdOCkceWLE4wQBCoayUIK4/z8SaOXfXquQjA047mwRUDgD1ZgUE
wQIhAManFM4+ZlPHstoIiwggQQwZNgskSf7iHUUxdMuEBbrpAiEAwMo8D796WCM4
T8eufvDWBGogFZW3J/hb1LUXvq4G2M0CIEmBZYdzO3XgvONEqf1VwfvyEDdLND4l
+OKzjB4KOfyRAiAKZJyaSLtCtxtZCa25gCg5crMqFrkZ+YSR0fVmvSD3XQIhAK51
PJkOxGFOXW6OgCged7jRNAJ8gQJRS094sTKR44Om
-----END RSA PRIVATE KEY-----
<span class="token comment"># 把公钥单独提取出来</span>
$ openssl rsa -in key.pem -out pub.pem -pubout
writing RSA key
$ <span class="token function">cat</span> pub.pem
-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAJWaPgx6yiLUE+GlDQuC6+U+gLYJtFls
fUJYz/8/AGabmF/ZDE8KQ4oPtaJrg/5pVZMzoB7uoTfuzm/jeE3BRJUCAwEAAQ<span class="token operator">==</span>
-----END PUBLIC KEY-----
<span class="token comment"># 检查密钥文件的一致性</span>
$ openssl rsa -in key.pem  --check
RSA key ok
……

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><p>上面的示例都在使用 -in 和 -out 指定输入输出，其实也可以使用重定向</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
$ openssl genrsa <span class="token number">512</span> <span class="token operator">&gt;</span> rsa.pem
Generating RSA private key, <span class="token number">512</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span>+++++++++++++++++++++++++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++++++++++++++++++++++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span>

$ <span class="token function">cat</span> rsa.pem
-----BEGIN RSA PRIVATE KEY-----
MIIBOgIBAAJBAL67EmxXiu2pFQDZtgMc9zePAOHB+P6PwS8ZhdmIFvLbfu36b/jj
a9HDKgcLo5hCyd/nkaSYZ3elkghjX8BckYsCAwEAAQJAHbs7m/fpiDKbO460eLfD
Mb3w/UAneEcgbh8kZkx4h1K7BW06/+fQXvfgE6z/EKJJETzKcaROMxEt5zqCjWfS
gQIhAOJWDRBtJ6rPhUo7BUku2Y5M03WmiLmW7/HkV89DCHCJAiEA17pm2Obgbti8
/vs1ZRiWfwtqBMb2n9xQkH5yXF6Y5HMCIQCYilhJrtdiJnR1v+tjFEEpx5tomnFh
a1mRlEyd8laYyQIgVldejnVpYjQRAKSebEX5BgQVfK/9SWIuRIa3UszxuI0CIE1m
x5yhLZWshvJ9lyaW5jQNcMGAsNFJDvv7VEej90yJ
-----END RSA PRIVATE KEY-----

$ openssl rsa -pubout <span class="token operator">&lt;</span> rsa.pem
writing RSA key
-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAL67EmxXiu2pFQDZtgMc9zePAOHB+P6P
wS8ZhdmIFvLbfu36b/jja9HDKgcLo5hCyd/nkaSYZ3elkghjX8BckYsCAwEAAQ<span class="token operator">==</span>
-----END PUBLIC KEY-----

$ openssl rsa -pubout <span class="token operator">&lt;</span> rsa.pem  <span class="token operator">&gt;</span> rsa-pub.pem
writing RSA key

$ openssl rsa -pubin <span class="token operator">&lt;</span> rsa-pub.pem --check
Only private keys can be checked

$ openssl rsa -pubin <span class="token operator">&lt;</span> rsa-pub.pem
writing RSA key
-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAL67EmxXiu2pFQDZtgMc9zePAOHB+P6P
wS8ZhdmIFvLbfu36b/jja9HDKgcLo5hCyd/nkaSYZ3elkghjX8BckYsCAwEAAQ<span class="token operator">==</span>
-----END PUBLIC KEY-----
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="demo-生成-ecc-密钥" tabindex="-1"><a class="header-anchor" href="#demo-生成-ecc-密钥" aria-hidden="true">#</a> demo: 生成 ecc 密钥</h2><p>man ecparam man ec</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建ec参数。To create EC parameters with the group &#39;prime192v1&#39;:</span>
openssl ecparam -out ec_param.pem -name prime192v1
<span class="token comment"># 列出所有可用的曲线名字，</span>
openssl ecparam -list_curves
<span class="token comment"># brainpoolP512r1, secp521r1, prime256v1</span>

<span class="token comment"># 校验参数文件：To validate given EC parameters:</span>
openssl ecparam -in ec_param.pem -check

<span class="token comment"># 用指定的参数文件创建密钥对</span>
openssl ecparam -in ec_param.pem -genkey

<span class="token comment"># 创建参数的同时创建私钥文件。To create EC parameters and a private key:</span>
openssl ecparam -out ec_key.pem -name prime192v1 -genkey

<span class="token comment"># 把参数输出到标准输出。To print out the EC parameters to standard output:</span>
openssl ecparam -in ec_param.pem -noout -text
<span class="token comment"># ps：-text 表示以人类可读的形式输出。 -noout 则表示抑制输出编码后的参数</span>

<span class="token comment">##########################</span>
<span class="token comment"># 用 3DES 加密私钥文件.</span>
openssl ec -in key.pem -des3 -out keyout.pem
<span class="token comment">#  ps: openssl ecn -ciphers 可以查看所有可用的加密算法</span>

<span class="token comment"># 从pem格式转为der格式</span>
openssl ec -in key.pem -ouform der -out keyout.der

<span class="token comment"># 查看 ECC 密钥文件的公钥、私钥组件，以及密钥参数。</span>
openssl ec -in key.pem -text
openssl ec -in key.pem -text -noout <span class="token comment"># -noout 指定抑制输出编码后的格式</span>
<span class="token comment"># 导出其中的公钥</span>
openssl ec -in key.pem  -pubout -out pubkey.pem
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="genrsa" tabindex="-1"><a class="header-anchor" href="#genrsa" aria-hidden="true">#</a> genrsa</h2><p>关于密钥的密码保护</p><p>genrsa 有个 -passout 选项，可以直接指定密码，还有 -* 允许指定任意支持的加密算法。 仅指定 -passout 没有用。 仅指定 -* （比如 -aes256），会提示输入密码。也可以同时指定二者。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl genrsa -passout pass:123456 -aes256 <span class="token operator">&gt;</span> rsa.pem
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>不加密的，是这样</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAwRVXUpXi4sC/tOtfZQrPoPJoeYuByaoYkQNH4gZnORN8B0N5
……
-----END RSA PRIVATE KEY-----
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>设置密码保护之后，会多两行相关信息。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-256-CBC,3D97EFFFE7B5B40955AEC145C9BB1983

r5ScBEcXaWsLth2ql7f/yIFRr22z/Fg/I3rA1QkT1oaq4dIqVOSeksbxTqzQ5ncl
1VjNgTsCMePAqhLs/gGE/DNAngXIE82U7/qop+4POdqC4VRRfDVzABuUz1R1lCmy
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="rsautl" tabindex="-1"><a class="header-anchor" href="#rsautl" aria-hidden="true">#</a> rsautl</h2><p>此命令用 RSA 算法加密、解密、签名、验证签名。 此命令直接使用 rsa 算法，所以只能操作小量的数据。</p><p>准备密钥和文件</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span>
$ openssl genrsa -aes256 -passout pass:<span class="token variable">$PASSWORD</span> <span class="token operator">&gt;</span> rsa.pem
Generating RSA private key, <span class="token number">2048</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span>

$ openssl rsa -pubout -passin pass:<span class="token variable">$PASSWORD</span> <span class="token operator">&lt;</span> rsa.pem <span class="token operator">&gt;</span> pub.pem
writing RSA key

$ <span class="token builtin class-name">echo</span> hello <span class="token operator">&gt;</span> hello.txt
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 公钥加密</span>
openssl rsautl -encrypt -in hello.txt -inkey  rsa.pem -passin pass:<span class="token variable">$PASSWORD</span> -out enc
<span class="token comment"># 注：私钥文件本身包含公钥，加密的时候也可以直接指定私钥文件，openssl 自动提取其中的公钥进行加密。</span>
openssl rsautl -encrypt -in hello.txt -inkey  pub.pem -pubin -out enc
<span class="token comment"># 另外，同样的文件，分别加密，得到的加密文件不一样</span>
<span class="token comment"># 私钥解密</span>
$ openssl rsautl -decrypt -in enc -inkey rsa.pem -passin pass:<span class="token variable">$PASSWORD</span>
hello

<span class="token comment"># 私钥签名</span>
openssl rsautl -sign -in hello.txt -inkey rsa.pem -passin pass:<span class="token variable">$PASSWORD</span> -out sign
<span class="token comment"># 同样的文件，分别签名，得到的结果是一样的。</span>
<span class="token comment"># 公钥验证</span>
$ openssl rsautl -verify -in sign -inkey pub.pem -pubin
hello
<span class="token comment"># Q. 签名文件，竟然包含原始数据，感觉不大对劲啊？</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>用私钥随便给一点数据签名</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl rsautl -sign -in <span class="token function">file</span> -inkey key.pem -out sig
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>恢复签名的数据</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl rsautl -verify -in sig -inkey key.pem
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>查看签名数据的原始格式</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl rsautl -verify -in sig -inkey key.pem -raw -hexdump
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0000 - 00 01 ff ff ff ff ff ff-ff ff ff ff ff ff ff ff   ................
0010 - ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff   ................
0020 - ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff   ................
0030 - ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff   ................
0040 - ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff   ................
0050 - ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff   ................
0060 - ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff   ................
0070 - ff ff ff ff 00 68 65 6c-6c 6f 20 77 6f 72 6c 64   .....hello world
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>很明显符合 PKCS#1 的数据格式。如果这数据是使用 encrypt/decrypt 命令生成的，数据块 格式会是 type2 (第二个字节位 0x02)，且中间填充的是随机字节而非 0xff。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl rsautl -sign -in file2 -inkey id.pem -out enc2
RSA operation error
<span class="token number">139705553990976</span>:error:0406C06E:rsa routines:RSA_padding_add_PKCS1_type_1:data too large <span class="token keyword">for</span> key size:<span class="token punctuation">..</span>/crypto/rsa/rsa_pk1.c:25:
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="openssl-s-client" tabindex="-1"><a class="header-anchor" href="#openssl-s-client" aria-hidden="true">#</a> openssl s_client</h1><p>2021-11-03</p><p>命令的用途。</p><blockquote><p>The s_client command implements a generic SSL/TLS client which connects to a remote host using SSL/TLS. It is a very useful diagnostic tool for SSL servers.</p></blockquote><h2 id="demo-访问远程-https-服务器并返回结果" tabindex="-1"><a class="header-anchor" href="#demo-访问远程-https-服务器并返回结果" aria-hidden="true">#</a> demo：访问远程 HTTPS 服务器并返回结果</h2><p>最基础的功能，充当与 TLS 服务端通信的交互式客户端。用 -connect 命令访问服务器。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl s_client -connect httpbin.org:443
<span class="token comment"># 或者省略 -connect</span>
openssl s_client httpbin.org:443
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会有如下输出，可以看到，openssl s_client 详细列出了证书层级，并打印了服务端证书。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>CONNECTED(00000003)
depth=2 C = US, O = Amazon, CN = Amazon Root CA 1
verify return:1
depth=1 C = US, O = Amazon, OU = Server CA 1B, CN = Amazon
verify return:1
depth=0 CN = httpbin.org
verify return:1
---
Certificate chain
 0 s:CN = httpbin.org
   i:C = US, O = Amazon, OU = Server CA 1B, CN = Amazon
 1 s:C = US, O = Amazon, OU = Server CA 1B, CN = Amazon
   i:C = US, O = Amazon, CN = Amazon Root CA 1
 2 s:C = US, O = Amazon, CN = Amazon Root CA 1
   i:C = US, ST = Arizona, L = Scottsdale, O = &quot;Starfield Technologies, Inc.&quot;, CN = Starfield Services Root Certificate Authority - G2
 3 s:C = US, ST = Arizona, L = Scottsdale, O = &quot;Starfield Technologies, Inc.&quot;, CN = Starfield Services Root Certificate Authority - G2
   i:C = US, O = &quot;Starfield Technologies, Inc.&quot;, OU = Starfield Class 2 Certification Authority
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIFbzCCBFegAwIBAgIQAzSkeUH+rIUZVH0Oqpvw5jANBgkqhkiG9w0BAQsFADBG
MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRUwEwYDVQQLEwxTZXJ2ZXIg
Q0EgMUIxDzANBgNVBAMTBkFtYXpvbjAeFw0yMDEyMjEwMDAwMDBaFw0yMjAxMTky
MzU5NTlaMBYxFDASBgNVBAMTC2h0dHBiaW4ub3JnMIIBIjANBgkqhkiG9w0BAQEF
AAOCAQ8AMIIBCgKCAQEAsR1fF+JAA+s/O8YGXONxK5JRc+4z/NtiFAww39lC/2qW
D2b/30ojrJVNbE500QzOTOO0YoJ3eWJupjIqFm3ImK+x8gSCWNz+pneWVY7RaoEb
mSgZRQ9YizYpVUnS4wb5UxhkzvCwsaEhqWja6yP0inaUIuW3gzrTuKTG2VBAnMtc
xYn7ttes9/BZebh0giSO0vtj7pg8Ai0n3I2moNHUumiJ1ye3pYEjys32sSb0HUGJ
f+T0k5ELs+dBM/Z7SuCq9toLNX/Uj196ZPQiv+BhCmM4VQyID5wR5riIR11/0z0E
r4FZjLAPNBFlE5bOMC87UXSf7kylvgZUuLHOKOFc2wIDAQABo4IChzCCAoMwHwYD
VR0jBBgwFoAUWaRmBlKge5WSPKOUByeWdFv5PdAwHQYDVR0OBBYEFHZOjrUHdkbF
RaBO20nVbqaNuinoMCUGA1UdEQQeMByCC2h0dHBiaW4ub3Jngg0qLmh0dHBiaW4u
b3JnMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUH
AwIwOwYDVR0fBDQwMjAwoC6gLIYqaHR0cDovL2NybC5zY2ExYi5hbWF6b250cnVz
dC5jb20vc2NhMWIuY3JsMCAGA1UdIAQZMBcwCwYJYIZIAYb9bAECMAgGBmeBDAEC
ATB1BggrBgEFBQcBAQRpMGcwLQYIKwYBBQUHMAGGIWh0dHA6Ly9vY3NwLnNjYTFi
LmFtYXpvbnRydXN0LmNvbTA2BggrBgEFBQcwAoYqaHR0cDovL2NydC5zY2ExYi5h
bWF6b250cnVzdC5jb20vc2NhMWIuY3J0MAwGA1UdEwEB/wQCMAAwggEFBgorBgEE
AdZ5AgQCBIH2BIHzAPEAdwApeb7wnjk5IfBWc59jpXflvld9nGAK+PlNXSZcJV3H
hAAAAXaC8EAVAAAEAwBIMEYCIQDNxxAPWT/gy6wFsupHR/4vfmLTtpxkCZt8FhqE
+quq9gIhAPXuElDhqg376uQXhF9W6q2TluHS/Xs4f1hB5sNwA9XNAHYAQcjKsd8i
RkoQxqE6CUKHXk4xixsD6+tLx2jwkGKWBvYAAAF2gvBAHgAABAMARzBFAiB1FlMU
CTCW/tGD8Pskp1jxeelWhd4/uJMhsuBjXs81dQIhANcn0p9bbEkyVjPopr3xBh1H
VxY7nZNecoqRzeE2e0elMA0GCSqGSIb3DQEBCwUAA4IBAQAnnWtk2DykzfJ+Xs2q
tYFutai46RkGb0rwXgeWNXzYl7MFu44gXCR5n3ctrrz83YlPJM7fBHsI1NR39XeD
yn1XiZeVuF3JGse2/gDuYf7aUKJoEXMpZclF8MLUAMKZS4zj6WwJdhYuIDHr8quP
7AkunuP8fZ8qyApDiDNAklENqsz40C26Nest8oSYSAbcXBD3RLtBLQot5O6XI88f
qKx1DjJaaDsFNdXT8O5NRX85Sy8XrgIt6fgi25Sw4HXepZmsmXDIAUyQnnCCLkiy
UAHjRHcbR6pWDmxjoMCPkVpPEPxPXfXjsZXELPbKewwW57x3xsmUidnR/WowI0ru
s+Zn
-----END CERTIFICATE-----
subject=CN = httpbin.org

issuer=C = US, O = Amazon, OU = Server CA 1B, CN = Amazon

---
No client certificate CA names sent
Peer signing digest: SHA512
Peer signature type: RSA
Server Temp Key: ECDH, P-256, 256 bits
---
SSL handshake has read 5510 bytes and written 429 bytes
Verification: OK
---
New, TLSv1.2, Cipher is ECDHE-RSA-AES128-GCM-SHA256
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-RSA-AES128-GCM-SHA256
    Session-ID: BD223B59767C7266F2636E06247F5DF1DBA5E291493A8D74D5020E15AE9E67B4
    Session-ID-ctx:
    Master-Key: 5E49A933CD2031579ACA4A7A11FCD60C2FBFBF90017BB5E946FE64BD93308D0B959FE68D911E16B634EB2509A675FA73
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 43200 (seconds)
    TLS session ticket:
    0000 - 01 62 3f 4b 7b 86 d6 06-2b f6 26 53 5c 90 ad a5   .b?K{...+.&amp;S\...
    0010 - 1c 18 f7 2a 4d e7 5a cb-0d 14 48 b8 b7 c3 8c a1   ...*M.Z...H.....
    0020 - ef e6 ed ad e7 6b 1d 03-d5 5f 83 06 6d 2f e8 87   .....k..._..m/..
    0030 - 5b a7 ac 50 a3 fd ab 2b-52 bb f9 c2 fd d1 48 16   [..P...+R.....H.
    0040 - 10 50 2b cf 19 d8 fa fb-a9 2d d9 b8 aa da 4a 86   .P+......-....J.
    0050 - 6a 79 97 bc e9 7a ab d8-e4 bb f9 92 62 0e 4a bc   jy...z......b.J.
    0060 - d3 a1 19 ac a8 59 c2 36-fa a1 09 53 8d f7 0c d0   .....Y.6...S....
    0070 - 8b 6e e1 bf 69 36 df 40-47 52 e5 f7 1d 49 be ca   .n..i6.@GR...I..
    0080 - 51 ca ec 94 31 02 c4 c2-01 23 1f 3a 05 47 f4 f6   Q...1....#.:.G..
    0090 - 81 1f 03 26 bb 34 41 01-01 51 6d 81 7b fb ea 11   ...&amp;.4A..Qm.{...
    00a0 - 3d f3 1b 8f 95 3d a5 bf-09 0d 7f 35 e5 c1 b8 3a   =....=.....5...:
    00b0 - 5e bd b7 f5 14 7a e9 84-2e 29 ee 27 57 60 c4 dd   ^....z...).&#39;W`..

    Start Time: 1635909678
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
---
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><p>此时暂停，等待输入，接着输入如下三行内容（第三行是空行），发送HTTP请求</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>GET /get HTTP/1.1
HOST: httpbin.org

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>服务端返回消息。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>HTTP/1.1 <span class="token number">200</span> OK
Date: Wed, 03 Nov <span class="token number">2021</span> 03:21:32 GMT
Content-Type: application/json
Content-Length: <span class="token number">200</span>
Connection: keep-alive
Server: gunicorn/19.9.0
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: <span class="token boolean">true</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;args&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin.org&quot;</span>,
    <span class="token string">&quot;X-Amzn-Trace-Id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Root=1-6182003c-2b940ef652d7835242737a14&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;origin&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;124.133.27.115&quot;</span>,
  <span class="token string">&quot;url&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;https://httpbin.org/get&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>暂停，等待输入，接着输入Ctrl-D模拟EOF，结束通信。然后命令输出 DONE。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>DONE
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="附-不要加协议前缀-识别不了" tabindex="-1"><a class="header-anchor" href="#附-不要加协议前缀-识别不了" aria-hidden="true">#</a> 附：不要加协议前缀，识别不了</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_client https://httpbin.org
<span class="token number">139724921500992</span>:error:2008F002:BIO routines:BIO_lookup_ex:system lib:<span class="token punctuation">..</span>/crypto/bio/b_addr.c:730:Servname not supported <span class="token keyword">for</span> ai_socktype
connect:errno<span class="token operator">=</span><span class="token number">0</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="附-访问远程-http-不会有结果" tabindex="-1"><a class="header-anchor" href="#附-访问远程-http-不会有结果" aria-hidden="true">#</a> 附：访问远程 HTTP 不会有结果</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl s_client -connect httpbin.org:80
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>自动就结束了</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>CONNECTED(00000003)
140059842250048:error:1408F10B:SSL routines:ssl3_get_record:wrong version number:../ssl/record/ssl3_record.c:331:
---
no peer certificate available
---
No client certificate CA names sent
---
SSL handshake has read 5 bytes and written 303 bytes
Verification: OK
---
New, (NONE), Cipher is (NONE)
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 0 (ok)
---
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="demo-提取服务端-ssl-tls-证书" tabindex="-1"><a class="header-anchor" href="#demo-提取服务端-ssl-tls-证书" aria-hidden="true">#</a> demo: 提取服务端 SSL/TLS 证书</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 把服务器证书保存到文件中</span>
openssl s_client -connect httpbin.org:443 <span class="token operator">&lt;</span>/dev/null <span class="token operator">|</span> openssl x509 -out httpbin.org.crt
<span class="token comment"># 直接解析证书字段</span>
openssl s_client -connect httpbin.org:443 <span class="token operator">&lt;</span>/dev/null <span class="token operator">|</span> openssl x509 -noout -text
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 获取根证书</span>
openssl s_client -connect httpbin.org:443 -showcerts <span class="token operator">&lt;</span>/dev/null <span class="token operator">|</span> openssl x509 -out root.crt
<span class="token comment"># 或者</span>
openssl s_client -connect httpbin.org:443 -showcerts <span class="token operator">&lt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">|</span> openssl x509 -out root.crt
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="实例-brief-和-quiet" tabindex="-1"><a class="header-anchor" href="#实例-brief-和-quiet" aria-hidden="true">#</a> 实例：-brief 和 -quiet</h2><p>s_client默认会输出证书和会话信息，如果希望简洁一些，可以指定 -brief 选项。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_client -connect letsencrypt.org:443 -brief
CONNECTION ESTABLISHED
Protocol version: TLSv1.3
Ciphersuite: TLS_AES_256_GCM_SHA384
Peer certificate: CN <span class="token operator">=</span> lencr.org
Hash used: SHA256
Signature type: ECDSA
Verification: OK
Server Temp Key: X25519, <span class="token number">253</span> bits
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>另外，-quiet 更简洁，但我发先会导致验证失败，不知何故。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_client -connect letsencrypt.org:443 -quiet
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">2</span> C <span class="token operator">=</span> US, O <span class="token operator">=</span> Internet Security Research Group, CN <span class="token operator">=</span> ISRG Root X1
verify return:1
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">1</span> C <span class="token operator">=</span> US, O <span class="token operator">=</span> Let&#39;s Encrypt, CN <span class="token operator">=</span> R3
verify return:1
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">0</span> CN <span class="token operator">=</span> lencr.org
verify return:1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h1 id="openssl-s-server" tabindex="-1"><a class="header-anchor" href="#openssl-s-server" aria-hidden="true">#</a> openssl s_server</h1><p>openssl s_server 监听 8443 端口，使用 server.pem 证书，</p><ul><li><p>服务端证书</p><ul><li><code>-cert infile</code> 默认 server.pem。</li><li>需要提供服务端证书的私钥文件 -key infile，默认使用证书</li><li>不使用证书 -nocert <blockquote><p>If this option is set then no certificate is used. This restricts the cipher suites available to the anonymous ones (currently just anonymous DH).</p></blockquote></li></ul></li><li><p>验证客户端证书</p><ul><li>默认不验证客户端证书，指定 -verify int, -Verify int 验证客户都安证书 -verify 选项开启验证，但客户端可以不提供证书，-Verify开启验证，且客户端必须提供证书。</li><li><code>-CAfile infile</code> 验证客户端时使用的证书</li><li><code>-no-CAfile</code></li></ul></li><li><p>详细级别</p><ul><li><code>-quiet</code> Inhibit printing of session and certificate information.</li><li><code>-brief</code> Provide a brief summary of connection parameters instead of the normal verbose output.</li></ul></li><li><p>模拟 HTTP</p><ul><li><code>-HTTP</code> Emulates a simple web server. Pages will be resolved relative to the current directory. The files loaded are assumed to contain a complete and correct HTTP response (lines that are part of the HTTP response line and headers must end with CRLF).</li></ul></li></ul><h2 id="demo-s-server-和-s-client-发送消息" tabindex="-1"><a class="header-anchor" href="#demo-s-server-和-s-client-发送消息" aria-hidden="true">#</a> demo: s_server 和 s_client 发送消息</h2><p>先启动服务端，默认监听 4433 端口，启动时要指定服务器证书和私钥文件路径</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># server</span>
openssl s_server -cert pem/server-cert.pem -key pem/server-key.pem  -brief
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>另开一个端口，作为客户端去连接服务器端，默认连接 localhost:4433</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_client -brief
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">0</span> CN <span class="token operator">=</span> localhost
verify error:num<span class="token operator">=</span><span class="token number">20</span>:unable to get <span class="token builtin class-name">local</span> issuer certificate
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">0</span> CN <span class="token operator">=</span> localhost
verify error:num<span class="token operator">=</span><span class="token number">21</span>:unable to verify the first certificate
CONNECTION ESTABLISHED
Protocol version: TLSv1.3
Ciphersuite: TLS_AES_256_GCM_SHA384
Peer certificate: CN <span class="token operator">=</span> localhost
Hash used: SHA256
Signature type: RSA-PSS
Verification error: unable to verify the first certificate
Server Temp Key: X25519, <span class="token number">253</span> bits
<span class="token comment"># 等待</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>同时，服务端会打印 TLS 会话信息，如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># server</span>
Protocol version: TLSv1.3
Client cipher list: TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:TLS_EMPTY_RENEGOTIATION_INFO_SCSV
Ciphersuite: TLS_AES_256_GCM_SHA384
Signature Algorithms: ECDSA+SHA256:ECDSA+SHA384:ECDSA+SHA512:Ed25519:Ed448:RSA-PSS+SHA256:RSA-PSS+SHA384:RSA-PSS+SHA512:RSA-PSS+SHA256:RSA-PSS+SHA384:RSA-PSS+SHA512:RSA+SHA256:RSA+SHA384:RSA+SHA512:ECDSA+SHA224:RSA+SHA224:DSA+SHA224:DSA+SHA256:DSA+SHA384:DSA+SHA512
No peer certificate
Supported Elliptic Groups: X25519:P-256:X448:P-521:P-384
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后在客户端输入消息，换行</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>hello
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>服务端就会看到消息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_server -cert pem/server-cert.pem -key pem/server-key.pem  -brief
Protocol version: TLSv1.3
<span class="token comment"># ...</span>
Supported Elliptic Groups: X25519:P-256:X448:P-521:P-384
hello
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>同样，服务器端也可以给客户端发消息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>message from server
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这是完整的客户端输出</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_client -brief
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">0</span> CN <span class="token operator">=</span> localhost
verify error:num<span class="token operator">=</span><span class="token number">20</span>:unable to get <span class="token builtin class-name">local</span> issuer certificate
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">0</span> CN <span class="token operator">=</span> localhost
verify error:num<span class="token operator">=</span><span class="token number">21</span>:unable to verify the first certificate
CONNECTION ESTABLISHED
Protocol version: TLSv1.3
Ciphersuite: TLS_AES_256_GCM_SHA384
Peer certificate: CN <span class="token operator">=</span> localhost
Hash used: SHA256
Signature type: RSA-PSS
Verification error: unable to verify the first certificate
Server Temp Key: X25519, <span class="token number">253</span> bits
hello
message from server
CONNECTION CLOSED BY SERVER
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这是完整的服务端</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_server -cert pem/server-cert.pem -key pem/server-key.pem  -brief
Protocol version: TLSv1.3
Client cipher list: TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:TLS_EMPTY_RENEGOTIATION_INFO_SCSV
Ciphersuite: TLS_AES_256_GCM_SHA384
Signature Algorithms: ECDSA+SHA256:ECDSA+SHA384:ECDSA+SHA512:Ed25519:Ed448:RSA-PSS+SHA256:RSA-PSS+SHA384:RSA-PSS+SHA512:RSA-PSS+SHA256:RSA-PSS+SHA384:RSA-PSS+SHA512:RSA+SHA256:RSA+SHA384:RSA+SHA512:ECDSA+SHA224:RSA+SHA224:DSA+SHA224:DSA+SHA256:DSA+SHA384:DSA+SHA512
No peer certificate
Supported Elliptic Groups: X25519:P-256:X448:P-521:P-384
hello
message from server
^C
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>另外，启动客户端时还可以指定 CA 文件，这样就能成功验证服务器证书了。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl s_client -brief -CAfile pem/ca.pem
CONNECTION ESTABLISHED
Protocol version: TLSv1.3
Ciphersuite: TLS_AES_256_GCM_SHA384
Peer certificate: CN <span class="token operator">=</span> localhost
Hash used: SHA256
Signature type: RSA-PSS
Verification: OK
Server Temp Key: X25519, <span class="token number">253</span> bits
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="demo-s-server-做简单的http服务器" tabindex="-1"><a class="header-anchor" href="#demo-s-server-做简单的http服务器" aria-hidden="true">#</a> demo: s_server 做简单的HTTP服务器</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> foo.txt</span>
HTTP/1.1 200 OK
Content-Type: text/plain
Content-Length: 7

success
EOF</span>

$ openssl s_server -cert pem/server-cert.pem -key pem/server-key.pem    -HTTP
Using default temp DH parameters
ACCEPT
FILE:foo.txt
FILE:foo.txt

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -k https://localhost:4433/foo.txt
success
$ <span class="token function">curl</span> -k https://localhost:4433/foo.txt
success
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="附-openssl-s-server-总是需要tls证书-待续" tabindex="-1"><a class="header-anchor" href="#附-openssl-s-server-总是需要tls证书-待续" aria-hidden="true">#</a> 附：openssl s_server 总是需要tls证书 待续</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">work_dir</span><span class="token operator">=</span>pem
<span class="token assign-left variable">host</span><span class="token operator">=</span>localhost

<span class="token comment"># 自签名证书，做 ca</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$work_dir</span>
openssl req -new -x509 -subj <span class="token string">&quot;/CN=ca-host&quot;</span> -days <span class="token number">3650</span> -keyout ca-key.pem -nodes -out ca-crt.pem

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h1 id="openssl-req" tabindex="-1"><a class="header-anchor" href="#openssl-req" aria-hidden="true">#</a> openssl req</h1><p>man openssl req</p><p>此命令的功能：1. <strong>生成证书请求文件</strong> 2. 查看验证证书请求文件 3. 生成自签名证书</p><p>openssl req 命令，指定 -new 或者 -newkey，则生成请求文件，指定 -x509 则生成自签名证书。 都不指定，则期望读取证书请求文件（从 -in 参数，默认stdin）。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-new  表示生成证书签名请求。需要同时通过 -key 指定所用的私钥文件。
      如果没有指定 -key 选项，则自动生成密钥对，此时指定 -newkey 可以控制密钥参数


-newkey arg 选项指定生成新的证书请求和新的私钥。（比new，能指定新生成的私钥类型）
    指定了此选项，默认带上-new（即生成请求文件），除非显式指定 -x509

-x509

-in filename    指定从何处读取输入密钥/证书请求文件。默认从标准输入。仅当没有指定
  创建选项（-new，-newkey，-x509）的时候才会读取证书请求文件。

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="选项" tabindex="-1"><a class="header-anchor" href="#选项" aria-hidden="true">#</a> 选项</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Usage: req [options]
Valid options are:
 -help               Display this summary
 -inform PEM|DER     Input format - DER or PEM
 -outform PEM|DER    Output format - DER or PEM
 -in infile          Input file
 -out outfile        Output file
 -key val            Private key to use
 -keyform format     Key file format
 -pubkey             Output public key
 -new                New request
 -config infile      Request template file
 -keyout outfile     File to send the key to
 -passin val         Private key password source
 -passout val        Output file pass phrase source
 -rand val           Load the file(s) into the random number generator
 -writerand outfile  Write random data to the specified file
 -newkey val         Specify as type:bits
 -pkeyopt val        Public key options as opt:value
 -sigopt val         Signature parameter in n:v form
 -batch              Do not ask anything during request generation
 -newhdr             Output &quot;NEW&quot; in the header lines
 -modulus            RSA modulus
 -verify             Verify signature on REQ
 -nodes              Don&#39;t encrypt the output key
 -noout              Do not output REQ
 -verbose            Verbose output
 -utf8               Input characters are UTF8 (default ASCII)
 -nameopt val        Various certificate name options
 -reqopt val         Various request text options
 -text               Text form of request
 -x509               Output a x509 structure instead of a cert request
                     (Required by some CA&#39;s)
 -subj val           Set or modify request subject
 -subject            Output the request&#39;s subject
 -multivalue-rdn     Enable support for multivalued RDNs
 -days +int          Number of days cert is valid for
 -set_serial val     Serial number to use
 -addext val         Additional cert extension key=value pair (may be given more than once)
 -extensions val     Cert extension section (override value in config file)
 -reqexts val        Request extension section (override value in config file)
 -precert            Add a poison extension (implies -new)
 -*                  Any supported digest
 -engine val         Use engine, possibly a hardware device
 -keygen_engine val  Specify engine to be used for key generation operations
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="配置" tabindex="-1"><a class="header-anchor" href="#配置" aria-hidden="true">#</a> 配置</h2><p>req 命令使用配置文件中的 <code>[ req ]</code> 节，对于 req 节中缺失的值，会去 default 中查找。</p><p>具体配置项，如下。</p><h3 id="input-password-output-password" tabindex="-1"><a class="header-anchor" href="#input-password-output-password" aria-hidden="true">#</a> input_password output_password</h3><p>如果需要读取私钥且私钥有密码保护，input_password 指定私钥密码。 如果会生成公钥且需要为私钥设置密码保护，output_password 指定私钥密码。 命令行选项 -passin 和 -passout 可以覆盖这两个配置项。</p><h3 id="default-bits" tabindex="-1"><a class="header-anchor" href="#default-bits" aria-hidden="true">#</a> default_bits</h3><p>如果会生成密钥，此选项指定密钥位数。缺省值 1024，允许最小值为 512。 命令行选项 -newkey 可以指定密钥位数，会覆盖此配置项。</p><h3 id="default-keyfile" tabindex="-1"><a class="header-anchor" href="#default-keyfile" aria-hidden="true">#</a> default_keyfile</h3><p>当生成新密钥时，此配置想指定默认密钥文件路径，命令行选项 -keyout可以覆盖此配置。 不指定输出路径，缺省输出到标准输出。</p><h3 id="oid-file-不懂" tabindex="-1"><a class="header-anchor" href="#oid-file-不懂" aria-hidden="true">#</a> oid_file ？？不懂</h3><h3 id="oid-section" tabindex="-1"><a class="header-anchor" href="#oid-section" aria-hidden="true">#</a> oid_section？？</h3><h3 id="randfile" tabindex="-1"><a class="header-anchor" href="#randfile" aria-hidden="true">#</a> RANDFILE ？？</h3><h3 id="encrypt-key" tabindex="-1"><a class="header-anchor" href="#encrypt-key" aria-hidden="true">#</a> encrypt_key</h3><p>当生成新密钥时，是否设置密码保护，配置项为 no 时不设密码保护，为 yes 时设置密码保护。 encrypt_key = no 等价于命令选项 -nodes。 为了兼容，encrypt_rsa_key 配置项等价于此。</p><h3 id="default-md" tabindex="-1"><a class="header-anchor" href="#default-md" aria-hidden="true">#</a> default_md</h3><p>设置默认摘要算法。所有 dgst 命令接收的摘要算法名称都可以。 可以被命令行选项覆盖。 某些签名算法（如 Ed25519, Ed448）的摘要算法是固定的，不受此配置项控制。</p><p>摘要算法举例：md4,md5,sha1,sha256,sha512,sha384。</p><h3 id="string-mask" tabindex="-1"><a class="header-anchor" href="#string-mask" aria-hidden="true">#</a> string_mask？？</h3><p>一般用不到。</p><h3 id="req-extensions" tabindex="-1"><a class="header-anchor" href="#req-extensions" aria-hidden="true">#</a> req_extensions</h3><p>指定证书请求中扩展段的信息。命令行选项 -reqexts 可覆盖此配置项。</p><p>具体配置参考 x509v3_config(5) 手册页。</p><h3 id="x509-extensions" tabindex="-1"><a class="header-anchor" href="#x509-extensions" aria-hidden="true">#</a> x509_extensions</h3><p>在使用 -x509 生成证书时，此配置想指定扩展段的信息。命令行选项 -extensions 可覆盖此 配置项。</p><h3 id="prompt" tabindex="-1"><a class="header-anchor" href="#prompt" aria-hidden="true">#</a> prompt</h3><p>和 distinguished_name 和 attributes 一起。</p><h3 id="utf8" tabindex="-1"><a class="header-anchor" href="#utf8" aria-hidden="true">#</a> utf8</h3><p>如果设置为 yes，则使用 utf-8 编码解析字段值，无论是来自配置文件还是来命令行。 默认按ASCII 编码解析字段值。</p><h3 id="attributes" tabindex="-1"><a class="header-anchor" href="#attributes" aria-hidden="true">#</a> attributes？？</h3><p>指定一些属性。当前 OpenSSL 的请求签名工具忽略这个配置项。 This specifies the section containing any request attributes: its format is the same as distinguished_name. Typically these may contain the challengePassword or unstructuredName types. They are currently ignored by OpenSSL&#39;s request signing utilities but some CAs might want them.</p><h3 id="distinguished-name" tabindex="-1"><a class="header-anchor" href="#distinguished-name" aria-hidden="true">#</a> distinguished_name</h3><p>生成证书请求或者生成证书时，DN 信息。单独描述。</p><h2 id="dn-信息" tabindex="-1"><a class="header-anchor" href="#dn-信息" aria-hidden="true">#</a> DN 信息</h2><p>首先看prompt的值，如果为no，则直接读取配置文件中指定的值作为DN信息</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token key attr-name">CN</span><span class="token punctuation">=</span><span class="token value attr-value">My Name</span>
<span class="token key attr-name">OU</span><span class="token punctuation">=</span><span class="token value attr-value">My Organization</span>
<span class="token key attr-name">emailAddress</span><span class="token punctuation">=</span><span class="token value attr-value">someone@somewhere.org</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果promp不是no，那么配置文件需要设置 DN 信息中各个字段的提示信息，格式如下</p><div class="language-ini ext-ini line-numbers-mode"><pre class="language-ini"><code><span class="token key attr-name">fieldName</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">prompt</span>&quot;</span>
<span class="token key attr-name">fieldName_default</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">default field value</span>&quot;</span>
<span class="token key attr-name">fieldName_min</span><span class="token punctuation">=</span> <span class="token value attr-value">2</span>
<span class="token key attr-name">fieldName_max</span><span class="token punctuation">=</span> <span class="token value attr-value">4</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>fieldName 对应输入提示语，如果用户输入空，则使用默认值，如果没有默认值则忽略这个字段。 即使设置了默认值，用户也可以输入 . 显式忽略这个字段。 字段的字符数必须位于 fieldName_min 和 fieldName_max 的范围内，同时可能有其他限制， 比如 CN 就只能是两个字符，且要求是可打印字符。</p><p>如果某个字段需要指定多个值，只有最后一个会生效，解决方法是搞个前缀，比如，字段 organizationName 第二个值可以通过<code>1.organizationName=value</code>的形式指定。 就是在字段名前面 xx. 前缀。</p><p>实际可使用的字段名称不是固定，但常见的名称都是支持的，比如： commonName, countryName, localityName, organizationName, organizationalUnitName, stateOrProvinceName。</p><blockquote><p>The actual permitted field names are any object identifier short or long names. These are compiled into OpenSSL and include the usual values such as commonName, countryName, localityName, organizationName, organizationalUnitName, stateOrProvinceName. Additionally emailAddress is included as well as name, surname, givenName, initials, and dnQualifier.</p></blockquote><blockquote><p>Additional object identifiers can be defined with the oid_file or oid_section options in the configuration file. Any additional fields will be treated as though they were a DirectoryString.</p></blockquote><h2 id="调试" tabindex="-1"><a class="header-anchor" href="#调试" aria-hidden="true">#</a> 调试</h2><p>使用自定义配置文件的时候，有可能遇到如下报错：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>unable to find &#39;distinguished_name&#39; in config
problems making Certificate Request
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>很明显，是因为没有设置 distinguished_name。 可以把这个看作 openssl 的一个bug。</p><p>ps：验证操作不需要此配置，生成证书请求也不需要，但生成自签名证书是需要的。</p><h1 id="openssl-x509" tabindex="-1"><a class="header-anchor" href="#openssl-x509" aria-hidden="true">#</a> openssl x509</h1><p>多用途证书工具。</p><ul><li>查看证书内容</li><li>转换证书格式</li><li>签署证书请求（迷你ca）</li><li>编辑证书的信任设置 Q. edit certificate trust settings. 是什么？</li></ul><p>选项太多，分成几个部分介绍。</p><p>-CA 签署证书 -signkey 自签名证书</p><p>没有 -CA 也没有 -signkey，则是查看证书。</p><p>x509 命令没有配置文件段，也没有 -config 选项，但提供了 -extfile 和 -extensions 选项作为补充。 同样没有 -subj 选项。难怪这个签署证书时必须提供证书请求或者证书，因为它需要提取其中的配置 信息啊。</p><h2 id="选项-1" tabindex="-1"><a class="header-anchor" href="#选项-1" aria-hidden="true">#</a> 选项</h2><h3 id="输入输出和通用选项" tabindex="-1"><a class="header-anchor" href="#输入输出和通用选项" aria-hidden="true">#</a> 输入输出和通用选项</h3><ul><li>-help</li><li>-inform PEM | DER</li><li>-outform PEM | DER</li><li>-in filename 输入文件路径，默认 stdin</li><li>-out filename 输出文件路径，默认 stdout</li><li>-digest 指定哈希算法。与签名或者展示选项配合，例如 -fingerprint，-signkey，-CA。 dgst 命令支持的哈希名称都可以。不指定时，对于 -fingerprint 默认为 SHA1，对于 -signkey和 -CA 是默认配置，一般为 SHA256.</li><li>-rand file 为随机数生成器提供随机数据的文件</li><li>[-writerand file] 不知道</li><li>-engine id 不知道</li><li>-preserve_dates 签署证书时，指定证书有效期，与 -days 互斥。</li></ul><h3 id="查看选项" tabindex="-1"><a class="header-anchor" href="#查看选项" aria-hidden="true">#</a> 查看选项</h3><p>注：-alias 和 -purpose 也是展示选项，但放在 TRUST TESTING 中介绍了。</p><ul><li>-text 以文本形式展示证书信息，事无巨细，都展示</li><li>-ext extensions 文本形式展示证书中指定的扩展段信息</li><li>-certopt option 与 -text 配合使用，定制输出格式。详见 TEXT OPTIONS 小节</li><li>-noout 抑制证书回显。默认会输出PEM格式的证书信息</li><li>-pubkey 以 PEM 格式输出整数的 SubjectPublicKeyInfo 信息段</li><li>-modulus 输出证书中公钥的 modulu 信息</li><li>-serial 输出证书序列号</li><li>-subject_hash 输出证书所有者的“哈希”。方便形成索引，以便根据主体名称查找证书文件。大概长这个样子：c2d11598。 Outputs the &quot;hash&quot; of the certificate subject name. This is used in OpenSSL to form an index to allow certificates in a directory to be looked up by subject name.</li><li>-issuer_hash 证书颁发者的“hash”</li><li>-ocspid 证书主题和公钥的 OCSP 哈希值</li><li>-hask 是 -subject_hash 的别名，为了后向兼容</li><li>-subject_hash_old 输出证书所有者的“哈希”，openssl 1.0.0 之前的哈希算法</li><li>-issuer_hash_old 输出证书所有者的“哈希”，penssl 1.0.0 之前的哈希算法</li><li>-subject 证书主体信息</li><li>-issuer 证书颁发者信息</li><li>-nameopt option 输出主体或者颁发者信息时的格式，NAME OPTIONS 小节</li><li>-email Outputs the email address(es) if any.</li><li>-ocsp_uri Outputs the OCSP responder address(es) if any.</li><li>-startdate Prints out the start date of the certificate, that is the notBefore date.</li><li>-enddate Prints out the expiry date of the certificate, that is the notAfter date.</li><li>-dates Prints out the start and expiry dates of a certificate.</li><li>-checkend arg 校验证书在 arg 秒之后是否会过期，如果过期，则退出状态非零。</li><li>-fingerprint 计算并输出证书在 DER 格式下的完整证书的哈希值。这叫做指纹。指纹相同就可以认为证书相同。</li><li>-C This outputs the certificate in the form of a C source file.</li></ul><h3 id="trust-settings-待续" tabindex="-1"><a class="header-anchor" href="#trust-settings-待续" aria-hidden="true">#</a> Trust settings 待续</h3><p>Q. 不知道这个怎么翻译才贴切。</p><p>Q. 看不懂这里的选项</p><h3 id="签名选项" tabindex="-1"><a class="header-anchor" href="#签名选项" aria-hidden="true">#</a> 签名选项</h3><p>x509 命令可以签署证书和请求，所以叫着“迷你ca”。</p><ul><li><p>-signkey arg 使用指定的私钥或引擎对输入文件自签名。</p><p>Q. 本来就是证书了，为什么还要签名？ Ans: 如果输入的是证书，证书的 issuer 变成自己的 subject name，然后把公钥换成 -signkey 指定的密钥，再重置证书有效期。</p><blockquote><p>If the input file is a certificate it sets the issuer name to the subject name (i.e. makes it self signed) changes the public key to the supplied value and changes the start and end dates. The start date is set to the current time and the end date is set to a value determined by the -days option. Any certificate extensions are retained unless the -clrext option is supplied; this includes, for example, any existing key identifier extensions.</p></blockquote><p>当输入文件是证书请求时，使用指定的私钥和请求中的 subject 名称生成自签名证书。 Q. 当私钥和证书请求中的密钥不是一对的时候，也能生成证书吗？ Ans: 能，指定会从指定的私钥提取公钥生成证书。换言之，证书请求中的公钥信息被摒弃了。</p><p>Q. 证书序号呢？没提，我猜是随机生成大整数作为序号。</p></li><li><p>-passin arg 私钥密码</p></li><li><p>-clrext 删除原有证书的扩展段信息。一般，当使用另一个证书构造新证书时（如 -signkey 和 -CA）才用到这个选项，默认 是会保留扩展段信息的。</p></li><li><p>-keyform PEM|DER|ENGINE 使用 -signkey 选项是，此选项指定私钥的格式</p></li><li><p>-days arg 指定证书有效天数，默认30天。与 -preserve_dates 互斥</p></li><li><p>-x509toreq Q. 不懂</p></li><li><p>-req 默认，x509 期望输入证书文件，指定此选项则告诉 x509 输入的是证书请求而非证书。</p></li><li><p>-set_serial n 使用 -signkey 或 -CA 选项时，可以使用此选项指定证书编号。此选项与 -CA 搭配时，序号文件（通过 -CAserial 或 -CAcreateserial 指定） 会被忽略</p></li><li><p>-CA filename 指定用于签发证书的ca证书，指定此选项后，x509 的行为就像一个“迷你CA”。从这个选项指定的证书的主体信息作为 新证书的签发者信息。</p><blockquote><p>The input file is signed by this CA using this option: that is its issuer name is set to the subject name of the CA and it is digitally signed using the CAs private key.</p></blockquote></li><li><p>-CAkey filename 指定用于签发证书的CA私钥。如果不指定这个选项，就从 -CA 指定的证书中提取私钥。 Q. 证书里可以包含私钥信息吗？</p></li><li><p>-CAserialfile filename ca的证书序列号文件。当指定 -CA 选项签署证书时，会使用序列号文件。 文件只有一行，内容是一个整数，它是下一个可用的证书序列号。 签名时，取它作为新证书的序列号，然后把序列号加一再写回文件中。 默认，序列号文件的名称是证书基本名加上 .srl 后缀，比如 ca.pem 对应 ca.srl。</p></li><li><p>-CAcreateserial 如果证书文件不存在就创建：新创建的文件内容是 02，而此时签发的证书序号为 1。 如果同时使用了 -CA 选项且序号文件不存在，则生成随机数字作为序号，这是推荐的做法。 ps：使用 -CA 的时候，当文件不存在时，还是会创建的。</p></li><li><p>-extfile filename 证书扩展段信息。如果不指定，则不向证书添加扩展信息。</p></li><li><p>-extension section 扩展段名称。如果不指定，则扩展信息要在default段中指定，或者在default段中通过 extensions 选项指 section。</p></li><li><p>-force_pubkey key 强制给用 key 做证书的公钥，而非证书请求中的公钥</p></li></ul><h1 id="openssl-ca" tabindex="-1"><a class="header-anchor" href="#openssl-ca" aria-hidden="true">#</a> openssl ca</h1><p>ca 小型 CA 应用程序。 需要四个文件，ca证书，ca私钥，序号文件，索引文件。</p><h2 id="说明-1" tabindex="-1"><a class="header-anchor" href="#说明-1" aria-hidden="true">#</a> 说明</h2><p>是小型 CA 应用程序，可以</p><ul><li>对各种格式的证书请求颁发证书</li><li>颁发 CRL</li><li>维护一个文本数据库，记录签发的证书和它们的状态</li></ul><h2 id="选项-2" tabindex="-1"><a class="header-anchor" href="#选项-2" aria-hidden="true">#</a> 选项</h2><p>挑感兴趣的</p><ul><li>-config filename 指定配置文件</li><li>-name section 指定要使用的配置节，即覆盖</li><li>-in filename 证书请求</li><li>-ss_cert filename 将要用 CA 去签名的自签名证书。Q. 哎呦呵，已经是证书了，再签一次，效果是什么？</li><li>-out filename 证书输出路径，默认把证书输出到标准输出中。</li><li>-outdir dirname 存放签名证书的目录，证书名称是证书序列号的十六进制 + .pem 后缀</li><li>-cert filenamne CA 证书</li><li>-keyfile filename 签发证书使用的私钥。Q. 这个私钥可以和 CA 证书不一致吗？</li><li>-keyform PEM|DER 证书格式，默认PEM</li><li>-key password 私钥的密码。ps 命令可以看到完整的命令行，所以慎用。</li><li>-selfsign 表示要进行自签名。此时如果 -keyfile 指定的私钥和证书请求中的公钥不匹配，就不会颁发证书。 在有 -spkac、 -ss_cert 或 -gencrl 之一的时候，此选项被忽略。 使用此选项的一个推论是，生成的自签名证书同样会出现在证书数据库中，且会和其它证书使用同样的序列号计数器。</li><li>-passin arg 密码。比 -key 要好一些</li><li>-startdate date 证书有效期 YYYYMMDDHHMMSSZ 格式。</li><li>-enddatea date</li><li>-days arg 证书有效时长。此时取当前时刻作为证书起始日期，然后根据时长计算终止日期</li><li>-md alg 指定摘要算法</li><li>-policy arg 对应配置文件的 policy 配置项</li><li>-preserveDN 默认，DN 字段的顺序与 policy 中列出的顺序一致。指定此选项后，则与证书请求中的DN字段顺序一致。这是为了 兼容 IE。</li><li>-batch 批处理模式</li><li>-extensions section 签发证书时使用这个 section 的信息设置证书扩展段，当未指定 -extfile 时，缺省值为 x509_extensions。 如果没有出现任何扩展 section，则签发 V1 版本的证书，如果出现了（即使是空的），则签发 V3 证书。</li><li>-extfile file 附加配置文件，提供证书扩展信息，使用 default section，除非指定了 -extensions 选项 替换默认的 x509_extensions 节整体（如果有），不是合并。</li><li>-subj arg 覆盖证书请求中的 subject 信息，格式为 <code>/type0=value0/type1=value1/type2=....</code>。关键字可用 <code>\</code> 转义，空白字符会保留，value可以为空，此时对应的type不会出现在证书中</li><li>-utf8</li><li>-create_serial 从序号文件读取序号失败时，创建新的随机序号作为下一个序号。 Q. 意思是会写入序号文件吗？不是，只要文件存在，就不再生成序号，如果文件内容不合规，则报错。 仅当序号文件不存在的时候才会生成序号。</li><li>-rand_serial 随机生成大整数做证书序号，忽略序号文件。</li></ul><h2 id="crl-选项-略-看不懂" tabindex="-1"><a class="header-anchor" href="#crl-选项-略-看不懂" aria-hidden="true">#</a> CRL 选项 略……看不懂</h2><h2 id="配置文件-1" tabindex="-1"><a class="header-anchor" href="#配置文件-1" aria-hidden="true">#</a> 配置文件</h2><p>如果指定了 -name，就是用它指定的 section，否则取 [ ca ] 或者 default 中的 default_ca 指定的 section。 此外，会直接读取 [ ca ] 中的 RANDFILE，preserver、msie_hack 这三个选项的值（如果有的话），但 RANDFILE 这个，可能是个 bug，将来版本未必如此。</p><p>许多配置项都有等价的命令行选项，同时出现时，命令行选项优先级更高，此外，对于必选配置项，必须在配置文件或者命令行选项中 提供值。</p><p>挑感兴趣的。</p><ul><li><p>new_certs_dir 必选，对应 -outdir</p></li><li><p>certificate 必选，对应 -cert</p></li><li><p>private_key 必选，对应 -keyfile</p></li><li><p>default_days 对应 -days</p></li><li><p>default_startdate 对应 -startdate，若未指定，则取当前时间。</p></li><li><p>default_enddate 对应 -enddate，此选项和 default_days 必须提供一个。Q. 同时指定，那个会生效？</p></li><li><p>default_md 必选，对应 -md 选项。但签名算法不需要哈希时（比如 Ed25519和Ed448），此选项不是必选。</p></li><li><p>database 必选，文本数据库文件路径，没有对应的命令行选项。此文件初始时可以为空。 Q. 有缺省值吗？会自动创建吗？</p></li><li><p>unique_subject 缺省为 yes，建议设为no。如果为yes，则数据库中记录的有效证书的subject必须唯一。如果为no，则可以重复。 为了兼容旧版（0.9.8），缺省值为yes。 证书的subject可以为空，多个证书的subject为空，不算重复。</p></li><li><p>serial 必选，序号文件，它包含下一个可用的证书需要，hex 形式。此文件必须存在且包含有效的序号。</p></li><li><p>x509_extensions 对应 -extensions。</p></li><li><p>preserve 对应 -preserveDN</p></li><li><p>policy 对应 -policy</p></li><li><p>copy_extensions 决定如何处理证书请求中的 extensions 字段。不设置此选项或者设为 none，忽略证书请求中扩展信息。 设置为 copy，则复制请求中的扩展字段到证书中，但已经有的不复制；copyall，全部复制，如果已经有的，用证书请求 中的覆盖它。 此字段主要用于允许证书请求提供特定扩展字段，如 subjectAltName。</p><pre><code>             请阅读 WARNINGS
</code></pre></li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[ CA_default ]
x509_extensions = usr_cert              # The extensions to add to the cert

[ usr_cert ]
basicConstraints=CA:FALSE
nsComment                       = &quot;OpenSSL Generated Certificate&quot;
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid,issuer
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="policy-格式" tabindex="-1"><a class="header-anchor" href="#policy-格式" aria-hidden="true">#</a> policy 格式</h2><p>policy 包含若干变量，对应由证书的 DN 字段名称构成，每个变量可以取值为</p><ul><li>match 要求字段值必须出现且和证书中的值一致。？？不明白。</li><li>supplied 要求字段值必须出现</li><li>optional 字段值可以出现</li></ul><p>任何没有列出的字段，会静默删除。除非指定了 -preserveDN 选项，但这是个怪异的行为，而非程序本意。 PS -preserveDN 的这个效果可能是个bug？</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[ policy_match ]
countryName             = match
stateOrProvinceName     = match
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="关于v3扩展段" tabindex="-1"><a class="header-anchor" href="#关于v3扩展段" aria-hidden="true">#</a> 关于v3扩展段</h2><p>默认，ca -&gt; ca_default 的 v3_extensions 指定扩展段对应的节。 或者 -extensions 命令行选项指定扩展段对应的节。</p><p>Q. 指定 -extfile 之后会如何？ Ans：见 “关于 -extfile 和 -extensions”</p><p>ca 只能签发证书不能生成签名请求，-extfile 和 -extensions 指定 v3 扩展字段。 不指定 -extfile，仅指定 -extensions，覆盖主配置文件的 x509_extensions 配置项， 从主配置文件中找 -extensions 指定的 section。 指定了 -extfile，不指定 -extensions，则使用 -extfile 中的默认节作为 v3 扩展字段配置 （Q. 可以包含无关字段吗？），</p><h2 id="关于database和serial选项" tabindex="-1"><a class="header-anchor" href="#关于database和serial选项" aria-hidden="true">#</a> 关于database和serial选项</h2><ul><li>数据库文件必须手动创建，哪怕是空的。</li><li>会提问是否签名，是否提交，提交选n，会取消签发证书。</li><li>序号文件可以交由 ca 创建，指定 -create_serial 即可。 但如果没有指定 -create_serial，会尝试只读模式打开序号文件，文件不存在，会报告失败。</li></ul><p>ca 会尝试只读模式打开序号文件，文件不存在，会报告失败。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt

openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>文件存在，但为空，会报错，载入序号失败 unable to load number from ca/serial</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
<span class="token function">touch</span> ca/serial
openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>文件存在，手动写入序号 1 同样报错，</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>unable to load number from ca/serial
:short line:../crypto/asn1/f_int.c:140:
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> ca/serial
openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>文件存在，手动写入长一点的序号，可以了</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
<span class="token builtin class-name">echo</span> <span class="token number">10000000000000000000000000</span> <span class="token operator">&gt;</span> ca/serial
openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>文件不存在，指定 -create_serial， 会自动创建文件，随机生成序号，把下一个序号写入</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt

openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert <span class="token punctuation">\</span>
  -create_serial
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>序号文件存在, 指定 -create_serial，正常</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt

openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert <span class="token punctuation">\</span>
  -create_serial
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>指定 -create_serial，且序号文件存在，但文件为空 报错：short line:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
<span class="token function">touch</span> ca/serial
openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert <span class="token punctuation">\</span>
  -create_serial
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以指定 -rand_serial，随机生成序号，若序号文件不存在会自动创建，还会把下一个序号写入； 若序号文件存在，也会随机生成序号，然后把下一个序号写入。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> ca/* -rvf <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt

openssl ca -in dist/server.csr -cert dist/ca-root.cert -keyfile dist/ca-root.key -passin pass:123456 <span class="token punctuation">\</span>
  -subj <span class="token string">&#39;/CN=user&#39;</span> <span class="token punctuation">\</span>
  -out dist/server.cert <span class="token punctuation">\</span>
  -rand_serial
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="关于-extfile-和-extensions" tabindex="-1"><a class="header-anchor" href="#关于-extfile-和-extensions" aria-hidden="true">#</a> 关于 -extfile 和 -extensions</h2><p>总结：指定 -extfile，则查找 extensions 时就完全屏蔽主配置文件了。</p><p>默认，使用 x509_extensions 字段指定的段作为扩展信息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert


<span class="token builtin class-name">alias</span> <span class="token assign-left variable">show</span><span class="token operator">=</span><span class="token string">&#39;openssl x509 -in server.cert -noout -text -certopt no_pubkey,no_sigdump&#39;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>指定 -extensions，会覆盖 x509_extensions 选项的值</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert <span class="token punctuation">\</span>
  -extensions ext2
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>指定 -extfile，则只从此文件读取扩展信息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert <span class="token punctuation">\</span>
  -extfile conf.d/ext3.conf
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>指定多个 -extfile，会合并这些 -extfile 中的扩展信息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert <span class="token punctuation">\</span>
  -extfile conf.d/ext3.conf <span class="token punctuation">\</span>
  -extfile conf.d/ext4.conf
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>同时指定 -extfile 和 -extensions，如果 -extensions 指定的段在主配置文件中 而不在 -extfile 中，则报错</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>ERROR: adding extensions <span class="token keyword">in</span> section ext2
<span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt
openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert <span class="token punctuation">\</span>
  -extensions ext2 <span class="token punctuation">\</span>
  -extfile conf.d/ext3.conf <span class="token punctuation">\</span>
  -extfile conf.d/ext4.conf
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>同时指定 -extfile 和 -extensions，且 -extensions 指定的段在 -extfile 中，则可以</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt

<span class="token function">cat</span> <span class="token operator">&gt;</span> ca/ext4.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[ ext4 ]
extendedKeyUsage = clientAuth
EOF</span>

openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert <span class="token punctuation">\</span>
  -extensions ext4 <span class="token punctuation">\</span>
  -extfile ca/ext4.conf
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>同时指定多个 -extfile 和一个 -extensions，则要求各个 -extfile 都包含 -extensions 指定的节</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>ERROR: adding extensions <span class="token keyword">in</span> section ext4

<span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt

<span class="token function">cat</span> <span class="token operator">&gt;</span> ca/ext4.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[ ext4 ]
extendedKeyUsage = clientAuth
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> ca/ext5.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
keyUsage = dataEncipherment
extendedKeyUsage = serverAuth
EOF</span>

openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert <span class="token punctuation">\</span>
  -extensions ext4 <span class="token punctuation">\</span>
  -extfile ca/ext4.conf <span class="token punctuation">\</span>
  -extfile ca/ext5.conf
<span class="token function">rm</span> -rvf ca/* <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p ca/certs <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> ca/index.txt


<span class="token function">cat</span> <span class="token operator">&gt;</span> ca/ext4.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[ ext4 ]
extendedKeyUsage = clientAuth
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> ca/ext5.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[ ext4 ]
keyUsage = dataEncipherment
extendedKeyUsage = serverAuth
EOF</span>

openssl ca -config conf.d/server-cert.conf -batch <span class="token punctuation">\</span>
  -in dist/server.csr <span class="token punctuation">\</span>
  -keyfile dist/ca-root.key -cert dist/ca-root.cert <span class="token punctuation">\</span>
  -passin pass:<span class="token variable">$PASSWD</span> <span class="token punctuation">\</span>
  -create_serial <span class="token punctuation">\</span>
  -out server.cert <span class="token punctuation">\</span>
  -extensions ext4 <span class="token punctuation">\</span>
  -extfile ca/ext4.conf <span class="token punctuation">\</span>
  -extfile ca/ext5.conf
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h1 id="demo-生成证书签名请求文件" tabindex="-1"><a class="header-anchor" href="#demo-生成证书签名请求文件" aria-hidden="true">#</a> Demo: 生成证书签名请求文件</h1><p>请求文件，唯一的入口 openssl req</p><p>req 生成证书签名请求文件时，可以不需要外部配置。</p><p>genrsa 命令生成的密钥默认不设密码保护，指定 -aes256 等密码名称，可以同时为密钥设置密码。 req 命令生成的密钥要求提供密码，还要求不小于 4 个字符，指定 -nodes 可以省略密码</p><h2 id="已有密钥对-生成请求文件" tabindex="-1"><a class="header-anchor" href="#已有密钥对-生成请求文件" aria-hidden="true">#</a> 已有密钥对，生成请求文件</h2><p>设私钥文件为 server-key.pem</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl genrsa -out server-key.pem
openssl req -new -key server-key.pem -out server-csr.pem -subj <span class="token string">&quot;/CN=example.com&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里的 <code>-new</code> 和 <code>-key server-key.pem</code> 是必须的参数。</p><p>-new 表示生成证书签名请求。</p><p>如果不指定 subj 选项，会交互式提问，要求填写 DN 信息。</p><h2 id="没有密钥对-直接生成密钥和请求文件" tabindex="-1"><a class="header-anchor" href="#没有密钥对-直接生成密钥和请求文件" aria-hidden="true">#</a> 没有密钥对，直接生成密钥和请求文件</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl req -new -newkey rsa:2048 -keyout server-key.pem -out server-req.pem -nodes -subj <span class="token string">&quot;/CN=example.com&quot;</span>
<span class="token comment"># 可以省略 -newkey 或 -new 二者之一</span>
openssl req -new -keyout server-key.pem -out server-req.pem -nodes -subj <span class="token string">&quot;/CN=example.com&quot;</span>
openssl req -newkey rsa:2048 -keyout server-key.pem -out server-req.pem -nodes -subj <span class="token string">&quot;/CN=example.com&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用 -new 选项时，如果没有指定 -key，则自动生成新密钥对。 使用 -newkey 时，如果没有指定 -x509，则隐含为 -new 选项。</p><h2 id="生成请求文件无需默认配置" tabindex="-1"><a class="header-anchor" href="#生成请求文件无需默认配置" aria-hidden="true">#</a> 生成请求文件无需默认配置</h2><p>req 生成证书签名请求文件时，可以不需要外部配置。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>openssl req -config /dev/null -new -newkey rsa:2048 -keyout server-key.pem -out server-req.pem -nodes -subj &quot;/CN=example.com&quot;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h1 id="生成自签名证书" tabindex="-1"><a class="header-anchor" href="#生成自签名证书" aria-hidden="true">#</a> 生成自签名证书</h1><p>openssl req 的 -x509 选项可用于生成自签名证书。 自签名证书的序列号，默认自动生成一个比较大的随机序列号。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>req -x509
    This option outputs a self signed certificate instead of a certificate request. This is typically used to generate a test certificate or a self signed root
    CA. The extensions added to the certificate (if any) are specified in the configuration file. Unless specified using the set_serial option, a large random
    number will be used for the serial number.

    If existing request is specified with the -in option, it is converted to the self signed certificate otherwise new request is created.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>openssl x509 的 -signkey 也能生成自签名证书，当然，有点别扭。x509 主要创建正常的证书的。</p><p>Q. 或许，ca 命令也能自签名？ Ans: 能。</p><p>关于扩展字段。req 签发证书时，设置扩展字段的方式：</p><ol><li>-addext</li><li>-extensions section（等价于-reqexts section）选项指定配置文件中的小节作为扩展段信息 Q. 默认，扩展段的对应的配置节名称是什么？</li></ol><p>ca和x509 命令签发证书时，设置扩展字段的方式：</p><ol><li>-extfile filename</li><li>-extensions section</li></ol><p>Q. 是不是意味着，x509 签发证书，不能撤销证书，而 ca 命令能。</p><h2 id="没有密钥-直接生成自签名证书" tabindex="-1"><a class="header-anchor" href="#没有密钥-直接生成自签名证书" aria-hidden="true">#</a> 没有密钥，直接生成自签名证书</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl req -new -x509 -newkey rsa:2048 -keyout ca-key.pem -out ca-crt.pem -nodes -subj <span class="token string">&quot;/CN=example.com&quot;</span> -days <span class="token number">365</span>

<span class="token comment"># -new 可以省略，因为 -x509 引出 -new</span>
<span class="token comment"># 如果采用默认密钥配置 -newkey 也可以省略</span>
<span class="token comment"># 默认有效期是一个月，仅为了演示的话，-days 365 也可以省略</span>
openssl req -x509 -keyout ca-key.pem -out ca-crt.pem -nodes -subj <span class="token string">&quot;/CN=example.com&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>PS：自签名证书，需要 distinguished_name 选项。安装 openssl 包时的默认配置就够了，有这个选项。</p><h2 id="已有密钥对-生成自签名证书" tabindex="-1"><a class="header-anchor" href="#已有密钥对-生成自签名证书" aria-hidden="true">#</a> 已有密钥对，生成自签名证书</h2><p>使用 -x509 + -key 即可。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl req -x509 -key ca-key.pem -days <span class="token number">100</span> -out ca-crt.pem -subj <span class="token string">&quot;/CN=ca-host&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="已有密钥对和请求文件-生成自签名证书" tabindex="-1"><a class="header-anchor" href="#已有密钥对和请求文件-生成自签名证书" aria-hidden="true">#</a> 已有密钥对和请求文件，生成自签名证书</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl req -x509 -in ca-csr.pem -key ca-key.pem  -out ca-crt.pem
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>而且在这种情形下无法指定 -subj 了，只能使用请求文件中的。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req -x509 -in ca-csr.pem -subj <span class="token string">&quot;/CN=ca-host&quot;</span> -key ca-key.pem
Cannot modify certificate subject
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>或者使用 openssl x509 也可以</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl x509 -req -in ca-csr.pem -signkey ca-key.pem -out ca-crt2.pem -days<span class="token operator">=</span><span class="token number">99</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="只有请求文件-没有私钥-无法生成自签名证书" tabindex="-1"><a class="header-anchor" href="#只有请求文件-没有私钥-无法生成自签名证书" aria-hidden="true">#</a> 只有请求文件，没有私钥，无法生成自签名证书</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req -x509 -in ca-csr.pem -subj <span class="token string">&quot;/CN=ca-host&quot;</span>
you need to specify a private key
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h1 id="签发证书" tabindex="-1"><a class="header-anchor" href="#签发证书" aria-hidden="true">#</a> 签发证书</h1><p>假设已有 ca-key.pem 和 ca-crt.pem，现提供证书请求文件 server-csr.pem，要求签发证书 server-crt.pem。</p><h2 id="x509-的-ca-系列选项" tabindex="-1"><a class="header-anchor" href="#x509-的-ca-系列选项" aria-hidden="true">#</a> x509 的 -CA 系列选项</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl x509 -req -in server-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial <span class="token punctuation">\</span>
  -days <span class="token number">365</span> -out server-crt.pem
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这样是 1.0 的版本。</p><p>要生成 v3 格式的证书，增加 -extfile 选项。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl x509 -req -in server-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial  <span class="token punctuation">\</span>
   -days <span class="token number">365</span> -out server-crt.pem <span class="token punctuation">\</span>
   -extfile /etc/ssl/openssl.cnf <span class="token punctuation">\</span>
   -extensions v3_req
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Q. x509 的 -signKey 选项如何呢?</p><p>Q. 签发二级 CA 试试。 Q. 私钥的密码 -passin 选项 Q. 使用 ca 命令， Q. 使用 gpg 统一管理根密钥。</p><p>Q. 有了 x509 为什么还要ca命令？ Ans：</p><ol><li>ca 命令只是为了演示一个基础的CA程序应当如何做，它不是专业的CA。</li><li>ca 命令比 x509 功能更多，比如crl。</li></ol><h2 id="ca-命令" tabindex="-1"><a class="header-anchor" href="#ca-命令" aria-hidden="true">#</a> ca 命令</h2><h1 id="openssl-dhparam" tabindex="-1"><a class="header-anchor" href="#openssl-dhparam" aria-hidden="true">#</a> openssl dhparam</h1><p><a href="https://www.cnblogs.com/f-ck-need-u/p/7103791.html" target="_blank" rel="noopener noreferrer">openssl dhparam(密钥交换) - 骏马金龙 - 博客园<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><p>2021-11-05</p><p>用于生成和管理dh文件。dh(Diffie-Hellman)是著名的密钥交换协议，或称为密钥协商协议， 它可以保证通信双方安全地交换密钥。但注意，它不是加密算法，所以不提供加密功能，仅仅 只是保护密钥交换的过程。在openvpn中就使用了该交换协议。关于dh算法的整个过程，见下文。</p><p>openssl dhparam命令集合了老版本的openssl dh和openssl gendh，后两者可能已经失效了， 即使存在也仅表示未来另有用途。</p><p>注意，dh协议文件生成速度随长度增长而急剧增长，使用随机数种子可以加快生成速度。</p><p>例如：生成1024长度的交换协议文件，其消耗的时间2秒不到。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@xuexi tmp<span class="token punctuation">]</span><span class="token comment"># time openssl dhparam -out dh.pem 1024</span>
real    0m1.361s
user    0m1.356s
sys     0m0.000s
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但生成长度2048的交换协议文件用了 33 秒，可见长度增长会导致协议生成的时间急剧增长。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">time</span> openssl dhparam -out dh.pem <span class="token number">2048</span>
Generating DH parameters, <span class="token number">2048</span> bit long safe prime, generator <span class="token number">2</span>
This is going to take a long <span class="token function">time</span>

real    0m33.908s
user    0m33.708s
sys     0m0.200s
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>而使用了64位随机数种子的同样命令只需？秒钟。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[root@xuexi tmp]# time openssl dhparam -rand rand.seed -out dh.pem 2048
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>openssl命令实现的是各种算法和加密功能，它的cpu的使用率会非常高，再结合dhparam， 可以使得openssl dhparam作为一个不错的cpu压力测试工具，并且可以长时间飙高cpu使用率。</p><h1 id="demos" tabindex="-1"><a class="header-anchor" href="#demos" aria-hidden="true">#</a> demos</h1><h2 id="demo-验证服务器证书是否与根-ca-证书匹配" tabindex="-1"><a class="header-anchor" href="#demo-验证服务器证书是否与根-ca-证书匹配" aria-hidden="true">#</a> demo：验证服务器证书是否与根 CA 证书匹配</h2><p>命令是 <code>openssl verify -CAfile ca.crt server.crt</code>如果两个证书匹配，命令将返回 server.crt: OK 以上命令仅适用于 pem 格式。 对于 .p12 格式，请先将其转换为 pem 格式:<code>openssl pkcs12 -in server.p12 -out server.crt -nodes</code></p><h2 id="证书里的中文" tabindex="-1"><a class="header-anchor" href="#证书里的中文" aria-hidden="true">#</a> 证书里的中文</h2><p>DN 字段包含中文的时候，用openssl生成证书签名请求时，加上-utf8就行了 <code>openssl req -utf8 -config openssl_utf8.cnf -new -out server.req</code> 查看证书时，给 x509 指定 -nameopt utf8 选项即可。 如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>openssl req -x509 -out ca2.cert -nodes -subj <span class="token string">&quot;/CN=test/description=你好&quot;</span> -utf8

$ openssl x509  -in ca2.cert -noout -subject
<span class="token assign-left variable">subject</span><span class="token operator">=</span>CN <span class="token operator">=</span> test, description <span class="token operator">=</span> <span class="token punctuation">\</span>E4<span class="token punctuation">\</span>BD<span class="token punctuation">\</span>A0<span class="token punctuation">\</span>E5<span class="token punctuation">\</span>A5<span class="token punctuation">\</span>BD
$ openssl x509  -in ca2.cert -noout -subject -nameopt utf8
<span class="token assign-left variable">subject</span><span class="token operator">=</span>CN<span class="token operator">=</span>test, <span class="token assign-left variable">description</span><span class="token operator">=</span>你好
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="证书请求-不能有-authoritykeyidentifier" tabindex="-1"><a class="header-anchor" href="#证书请求-不能有-authoritykeyidentifier" aria-hidden="true">#</a> 证书请求，不能有 authorityKeyIdentifier</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[ v3_req_for_root_ca ]
basicConstraints = critical,CA:TRUE,pathlen:3
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid:always,issuer
keyUsage =  keyCertSign, cRLSign
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>140492245157184:error:22077079:X509 V3 routines:v2i_AUTHORITY_KEYID:no issuer certificate:../crypto/x509v3/v3_akey.c:103: 140492245157184:error:22098080:X509 V3 routines:X509V3_EXT_nconf:error in extension:../crypto/x509v3/v3_conf.c:47:name=authorityKeyIdentifier, value=keyid:always,issuer</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/xizhan1995/note-openssl/edit/master/docs/origin/openssl.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2022/5/19 12:26:03</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: chenxizhan1995@163.com">chenxizhan</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/note-openssl/assets/js/runtime~app.cf3cc7e9.js" defer></script><script src="/note-openssl/assets/js/812.64b59b29.js" defer></script><script src="/note-openssl/assets/js/app.0686d1e8.js" defer></script>
  </body>
</html>
